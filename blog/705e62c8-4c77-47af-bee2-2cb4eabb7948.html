<!DOCTYPE html><html lang="zh-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1.0,viewport-fit=cover"/><title>jotai原理篇<!-- --> - <!-- -->文钦的个人日志</title><meta name="keywords" content="jotai,状态管理"/><meta name="description" content="
 介绍
[Jotai](https:jotai.org/docs/introduction)是一种原子化的状态管理方案。采用的 Atom + hook + Context的方式来解决React的数据管理。

当Atom更新的时候不会触发Context的更新，只会更新订阅了Atom的组件。

Jotai 有一个非常小的 API，并且是面向 TypeScript 的。 它"/><meta property="og:title" content="jotai原理篇 - 文钦的个人日志"/><meta property="og:url" content="https://vwood.xyz/blog/705e62c8-4c77-47af-bee2-2cb4eabb7948"/><meta name="next-head-count" content="8"/><meta name="baidu-site-verification" content="code-qLvQxBZOZA"/><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/><meta http-equiv="Cache-Control" content="no-siteapp"/><link rel="icon" href="/favicon.ico"/><meta name="author" content="文钦,1061225829@qq.com"/><meta property="site_name" content="文钦的个人日志"/><meta name="google-site-verification" content="LE9f0-2YGlWDKgo5955hV_-oeN3Uq74EN_6gcKaJ60U"/><meta property="og:type" content="website"/><meta property="og:site_name" content="文钦的个人日志"/><link rel="dns-prefetch" href="cdn.vwood.xyz"/><link rel="dns-prefetch" href="cloud.vwood.xyz"/><link rel="dns-prefetch" href="file.vwood.xyz"/><meta name="msvalidate.01" content="3E915E4B19B295BCF5E1FEB5AA8367EB"/><meta name="baidu_union_verify" content="a673bc08063b1108073e80d745c6be14"/><meta name="360-site-verification" content="3a57e570191c7aa35ea273b1dc587150"/><meta name="theme-color" content="#ffffff"/><link rel="preload" href="/_next/static/css/7e90e60a9e5e6c24.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7e90e60a9e5e6c24.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dd63efe9eb313a8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dd63efe9eb313a8.css" data-n-p=""/><link rel="preload" href="/_next/static/css/0b4c08f05448376e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0b4c08f05448376e.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-d1ced160d4eb3748.js" defer=""></script><script src="/_next/static/chunks/framework-beeb81ad8570a989.js" defer=""></script><script src="/_next/static/chunks/main-2c5c31b519427824.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e7fd185ac745596f.js" defer=""></script><script src="/_next/static/chunks/175675d1-62aa9bb626fe4428.js" defer=""></script><script src="/_next/static/chunks/61-0bc427fa690628ba.js" defer=""></script><script src="/_next/static/chunks/305-ee87e158bd818b49.js" defer=""></script><script src="/_next/static/chunks/51-350cf45767b4e10a.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-59d9c9dd105f5a35.js" defer=""></script><script src="/_next/static/kixI1C9mn6Usu_fHeTZRq/_buildManifest.js" defer=""></script><script src="/_next/static/kixI1C9mn6Usu_fHeTZRq/_ssgManifest.js" defer=""></script></head><body class="custom_class"><div id="__next"><section class="ant-layout ant-layout-has-sider style_layout__lI5tQ" id="layout"><header class="ant-layout-header"><div class="style_header__ScyKA"><nav class="style_header_left__MwL2y"><a class="style_logo-container__V_i5n" href="/"><img alt="logo" src="/images/logo.png"/><h3>文钦的个人日志</h3></a><ul class="ant-menu-overflow ant-menu ant-menu-root ant-menu-horizontal ant-menu-light style_navs__cT4uk" role="menu" tabindex="0" data-menu-list="true"><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:0" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/">首页</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:1" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/tools">工具</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:2" role="menuitem" tabindex="-1" value="_blank"><span class="ant-menu-title-content"><a target="_blank" href="https://let-hooks.vwood.xyz">Hooks</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:3" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/my-recommend">好文推荐</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:4" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/about">关于</a></span></li><li class="ant-menu-overflow-item ant-menu-overflow-item-rest ant-menu-submenu ant-menu-submenu-horizontal" style="opacity:0;height:0;overflow-y:hidden;order:9007199254740991;pointer-events:none;position:absolute" aria-hidden="true" role="none"><div role="menuitem" class="ant-menu-submenu-title" tabindex="-1" aria-expanded="false" aria-haspopup="true"><span role="img" aria-label="ellipsis" class="anticon anticon-ellipsis"><svg viewBox="64 64 896 896" focusable="false" data-icon="ellipsis" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M176 511a56 56 0 10112 0 56 56 0 10-112 0zm280 0a56 56 0 10112 0 56 56 0 10-112 0zm280 0a56 56 0 10112 0 56 56 0 10-112 0z"></path></svg></span><i class="ant-menu-submenu-arrow"></i></div></li></ul><div style="display:none" aria-hidden="true"></div></nav><div class="style_header_right__pnukD"><div class="style_ads__bENq0"><ins class="adsbygoogle" style="display:inline-block;text-align:center;width:400px;height:60px" data-ad-layout="in-header" data-ad-format="fluid" data-ad-client="ca-pub-6887995008287565" data-ad-slot="8657788489" data-full-width-responsive="true"></ins></div><span role="img" aria-label="menu" tabindex="-1" class="anticon anticon-menu style_menu-icon__3wbdv"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><main class="ant-layout-content style_layout-content__nrtXO"><div class="style_detail_container__K7ALK"><div class="style_main__tK6AF"><div class="style_content__Gif1x"><div class="style_post_container__Ayu6o"><div class="style_post__dVMJC"><div class="style_post_content__sRh5M"><div class="style_post_header__kL41j"><h1 class="style_name__yhPOn" title="jotai原理篇">jotai原理篇</h1><div class="style_base-info__fcDVY"><span class="style_item__VwCzm"><i class="iconfont"></i><span>这篇文章发表于 <span>2023年08月19日，星期六，22:01</span></span><div class="ant-divider ant-divider-vertical" role="separator"></div></span><div><button type="button" class="ant-btn ant-btn-link ant-btn-sm"><span>分享</span></button></div></div></div><img class="style_post_headerImg__8pYfy" src="//file.vwood.xyz/2023/08/20/upload_sv0wcr8j84x8y9atlbdl8yhz6w85vpgs.png!/fw/850" alt="jotai原理篇" loading="lazy"/><div><div class="style_content__Gif1x"><div class="style_marked__AZOQ3"><div class="markdown-body"><h2>介绍</h2>
<p><a href="https://jotai.org/docs/introduction">Jotai</a>是一种原子化的状态管理方案。采用的 <code>Atom</code> + <code>hook</code> + <code>Context</code>的方式来解决React的数据管理。</p>
<p>当<code>Atom</code>更新的时候不会触发Context的更新，只会更新订阅了<code>Atom</code>的组件。</p>
<p>Jotai 有一个非常小的 API，并且是面向 TypeScript 的。 它与 React 的集成 useState hook 一样简单易用，但所有状态都是全局可访问的，派生状态易于实现，并且自动消除了额外的重新渲染</p>
<p>同时还提供了<code>jotai/utils</code>，这些函数增加了对在 localStorage（或 URL 哈希）中保留原子状态、在服务器端渲染期间混合原子状态、创建具有 set 函数（包括类似 Redux 的 reducers 和 action 类型）的原子等等的支持！</p>
<p>特征:</p>
<ul>
<li>核心API只有2KB</li>
<li>很多的实用工具和集成</li>
<li>对TypeScript友好</li>
<li>适用于 Next.js、Gatsby、Remix 和 React Native</li>
<li>使用 SWC 和 Babel 插件响应快速刷新</li>
</ul>
<p>本文基于jotai v2.2.1版本。</p>
<h2>使用</h2>
<p><a href="https://github.com/pmndrs/jotai/tree/main/examples">例子</a></p>
<h4>创建atom</h4>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#00e0e0">import</span><span> </span><span class="token imports" style="color:#fefefe">{</span><span class="token imports"> atom </span><span class="token imports" style="color:#fefefe">}</span><span> </span><span class="token module" style="color:#00e0e0">from</span><span> </span><span class="token" style="color:#abe338">&#x27;jotai&#x27;</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">const</span><span> countAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<p>在组件中使用</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-tsx" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#00e0e0">import</span><span> </span><span class="token imports" style="color:#fefefe">{</span><span class="token imports"> useAtom </span><span class="token imports" style="color:#fefefe">}</span><span> </span><span class="token module" style="color:#00e0e0">from</span><span> </span><span class="token" style="color:#abe338">&#x27;jotai&#x27;</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">function</span><span> </span><span class="token maybe-class-name" style="color:#ffd700">Counter</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> </span><span class="token" style="color:#fefefe">[</span><span>count</span><span class="token" style="color:#fefefe">,</span><span> setCount</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useAtom</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">&lt;</span><span class="token" style="color:#ffa07a">h1</span><span class="token" style="color:#fefefe">&gt;</span><span class="token plain-text">
</span><span class="token plain-text">      </span><span class="token" style="color:#fefefe">{</span><span>count</span><span class="token" style="color:#fefefe">}</span><span class="token plain-text">
</span><span class="token plain-text">      </span><span class="token" style="color:#fefefe">&lt;</span><span class="token" style="color:#ffa07a">button</span><span class="token" style="color:#ffa07a"> </span><span class="token" style="color:#abe338">onClick</span><span class="token script language-javascript script-punctuation" style="color:#ffa07a">=</span><span class="token script language-javascript" style="color:#fefefe">{</span><span class="token script language-javascript" style="color:#fefefe">(</span><span class="token script language-javascript" style="color:#fefefe">)</span><span class="token script language-javascript" style="color:#ffa07a"> </span><span class="token script language-javascript arrow" style="color:#ffa07a">=&gt;</span><span class="token script language-javascript" style="color:#ffa07a"> </span><span class="token script language-javascript" style="color:#ffd700">setCount</span><span class="token script language-javascript" style="color:#fefefe">(</span><span class="token script language-javascript" style="color:#fefefe">(</span><span class="token script language-javascript" style="color:#ffa07a">c</span><span class="token script language-javascript" style="color:#fefefe">)</span><span class="token script language-javascript" style="color:#ffa07a"> </span><span class="token script language-javascript arrow" style="color:#ffa07a">=&gt;</span><span class="token script language-javascript" style="color:#ffa07a"> c </span><span class="token script language-javascript" style="color:#00e0e0">+</span><span class="token script language-javascript" style="color:#ffa07a"> </span><span class="token script language-javascript" style="color:#00e0e0">1</span><span class="token script language-javascript" style="color:#fefefe">)</span><span class="token script language-javascript" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">&gt;</span><span class="token plain-text">add</span><span class="token" style="color:#fefefe">&lt;/</span><span class="token" style="color:#ffa07a">button</span><span class="token" style="color:#fefefe">&gt;</span><span class="token plain-text">
</span><span class="token plain-text">    </span><span class="token" style="color:#fefefe">&lt;/</span><span class="token" style="color:#ffa07a">h1</span><span class="token" style="color:#fefefe">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<h4>衍生atom</h4>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-tsx" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> doubledCountAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> </span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">function</span><span> </span><span class="token maybe-class-name" style="color:#ffd700">DoubleCounter</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> </span><span class="token" style="color:#fefefe">[</span><span>doubledCount</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useAtom</span><span class="token" style="color:#fefefe">(</span><span>doubledCountAtom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#fefefe">&lt;</span><span class="token" style="color:#ffa07a">h2</span><span class="token" style="color:#fefefe">&gt;</span><span class="token" style="color:#fefefe">{</span><span>doubledCount</span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">&lt;/</span><span class="token" style="color:#ffa07a">h2</span><span class="token" style="color:#fefefe">&gt;</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>从多个atom衍生</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> count1 </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span><span></span><span class="token" style="color:#00e0e0">const</span><span> count2 </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">)</span><span>
</span><span></span><span class="token" style="color:#00e0e0">const</span><span> count3 </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">3</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span></span><span class="token" style="color:#00e0e0">const</span><span> sum </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>count1</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>count2</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">+</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>count3</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<h4>可读可写atom</h4>
<p>默认atom就是可读可写的</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> decrementCountAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">,</span><span> set</span><span class="token" style="color:#fefefe">,</span><span> _arg</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">-</span><span> </span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">)</span><span>
</span><span></span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<h4>只读atom</h4>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> readOnlyAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> </span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<h4>只写atom</h4>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> multiplyCountAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">,</span><span> set</span><span class="token" style="color:#fefefe">,</span><span> by</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span>
</span><span>  </span><span class="token" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">*</span><span> by</span><span class="token" style="color:#fefefe">)</span><span>
</span><span></span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<h4>useAtomValue</h4>
<p>获取atom的值</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> count </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useAtomValue</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<h4>useSetAtom</h4>
<p>设置atom的值</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> setCount </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useSetAtom</span><span class="token" style="color:#fefefe">(</span><span>countAtom</span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<h2>工具函数</h2>
<p>Jotai提供了一些使用的工具函数，方便业务使用。</p>
<h3>本地存储 <a href="https://jotai.org/docs/utilities/storage">atomWithStorage</a></h3>
<p>支持将数据持久化到本地</p>
<p><a href="https://codesandbox.io/s/jotai-persistence-vuwi7?from-embed=&amp;file=/src/app.js:181-196">在线例子</a></p>
<h3>缓存 <a href="https://jotai.org/docs/utilities/family">atomFamily</a></h3>
<p>使用atomFamily复用已存在的atom</p>
<h3>数组 <a href="https://jotai.org/docs/utilities/split">splitAtom</a></h3>
<p>对数据项自动进行atom包装，同时提供了<code>remove</code>、<code>insert</code>和<code>move</code>操作</p>
<h2>atom</h2>
<p>atom函数用于创建atom配置，紧紧只是一个配置对象，不保存atom的值(原始atom会将默认值保存在init中)，atom对象是不可变的，值保存在store中，通过<code>store.get</code>获取</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> countAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">10</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span></code></div></pre>
<p>atom源码:</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#00e0e0">export</span><span> </span><span class="token" style="color:#00e0e0">function</span><span> </span><span class="token generic-function" style="color:#ffd700">atom</span><span class="token generic-function generic class-name" style="color:#00e0e0">&lt;</span><span class="token generic-function generic class-name maybe-class-name">Value</span><span class="token generic-function generic class-name" style="color:#fefefe">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name maybe-class-name">Args</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name" style="color:#00e0e0">extends</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name" style="color:#abe338">unknown</span><span class="token generic-function generic class-name" style="color:#fefefe">[</span><span class="token generic-function generic class-name" style="color:#fefefe">]</span><span class="token generic-function generic class-name" style="color:#fefefe">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name maybe-class-name">Result</span><span class="token generic-function generic class-name" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>  read</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Value</span><span> </span><span class="token" style="color:#00e0e0">|</span><span> </span><span class="token maybe-class-name">Read</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">SetAtom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Args</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Result</span><span class="token" style="color:#00e0e0">&gt;&gt;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>  write</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Write</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Args</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Result</span><span class="token" style="color:#00e0e0">&gt;</span><span>
</span><span></span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  </span><span class="token" style="color:#d4d0ab">// atom的key，可以在React中作为组件的key使用</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> key </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token template-string template-punctuation" style="color:#abe338">`</span><span class="token template-string" style="color:#abe338">atom</span><span class="token template-string interpolation interpolation-punctuation" style="color:#fefefe">${</span><span class="token template-string interpolation" style="color:#00e0e0">++</span><span class="token template-string interpolation">keyCount</span><span class="token template-string interpolation interpolation-punctuation" style="color:#fefefe">}</span><span class="token template-string template-punctuation" style="color:#abe338">`</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> config </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token function-variable" style="color:#ffd700">toString</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> key</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">typeof</span><span> read </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token" style="color:#abe338">&#x27;function&#x27;</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// read是函数表示是一个衍生的atom</span><span>
</span><span>    config</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">read</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> read
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// read为非函数类型</span><span>
</span><span>    config</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">init</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> read
</span><span>    config</span><span class="token" style="color:#fefefe">.</span><span class="token method-variable function-variable method property-access" style="color:#ffd700">read</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>config</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 设置默认的write，设置当前atom的值</span><span>
</span><span>    config</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">write</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Getter</span><span class="token" style="color:#fefefe">,</span><span> set</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Setter</span><span class="token" style="color:#fefefe">,</span><span> arg</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">SetStateAction</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>config</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">typeof</span><span> arg </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token" style="color:#abe338">&#x27;function&#x27;</span><span> </span><span class="token" style="color:#00e0e0">?</span><span> </span><span class="token" style="color:#ffd700">arg</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>config</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">:</span><span> arg</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>write</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 覆盖默认的write</span><span>
</span><span>    config</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">write</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> write
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">return</span><span> config
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span></code></div></pre>
<p>上面的代码可以看出atom的一些特征：</p>
<ol>
<li>每个atom都有一个唯一的<code>key</code>，并重写了config的toString方法（可以直接在React组件中将atom作为key使用）。</li>
<li>read参数不为函数时，设置默认的read=(get) =&gt; get(config)读取atom自身的值。</li>
<li>atom默认的<code>write</code>函数是修改自身的值，所以原始atom是可读可写的，衍生的atom没有没有默认write方法。</li>
<li>原始atom的初始值保存在<code>init</code>中，并且不能修改。</li>
</ol>
<h2>useAtom</h2>
<p>useAtom使用atom与store结合起来的桥梁,使用 <code>useAtomValue</code>读取值、<code>useSetAtom</code>设置atom的值
<img src="https://raw.githubusercontent.com/abelce/blogs/master/jotai/upload_tilhjximg25aw5dm3pdm4zzl6o9302ye.webp!/fw/850" alt="upload_tilhjximg25aw5dm3pdm4zzl6o9302ye.webp"/></p>
<p>useAtomValue代码如下：</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#00e0e0">export</span><span> </span><span class="token" style="color:#00e0e0">function</span><span> </span><span class="token generic-function" style="color:#ffd700">useAtomValue</span><span class="token generic-function generic class-name" style="color:#00e0e0">&lt;</span><span class="token generic-function generic class-name maybe-class-name">Value</span><span class="token generic-function generic class-name" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span> options</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Options</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> store </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useStore</span><span class="token" style="color:#fefefe">(</span><span>options</span><span class="token" style="color:#fefefe">)</span><span>
</span>  
<span>  </span><span class="token" style="color:#00e0e0">const</span><span> </span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">[</span><span>valueFromReducer</span><span class="token" style="color:#fefefe">,</span><span> storeFromReducer</span><span class="token" style="color:#fefefe">,</span><span> atomFromReducer</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">,</span><span> rerender</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useReducer</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">(</span><span>prev</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> nextValue </span><span class="token" style="color:#00e0e0">=</span><span> store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>
</span><span>          </span><span class="token known-class-name class-name">Object</span><span class="token" style="color:#fefefe">.</span><span class="token" style="color:#00e0e0">is</span><span class="token" style="color:#fefefe">(</span><span>prev</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">,</span><span> nextValue</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>          prev</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">1</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">===</span><span> store </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>          prev</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">2</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token" style="color:#00e0e0">===</span><span> atom
</span><span>        </span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// 如果前后两次value、store、atom都一样，返回上一次修改的值</span><span>
</span><span>          </span><span class="token control-flow" style="color:#00e0e0">return</span><span> prev
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#fefefe">[</span><span>nextValue</span><span class="token" style="color:#fefefe">,</span><span> store</span><span class="token" style="color:#fefefe">,</span><span> atom</span><span class="token" style="color:#fefefe">]</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>      </span><span class="token nil" style="color:#00e0e0">undefined</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">[</span><span>store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span> store</span><span class="token" style="color:#fefefe">,</span><span> atom</span><span class="token" style="color:#fefefe">]</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span>  </span><span class="token" style="color:#00e0e0">let</span><span> value </span><span class="token" style="color:#00e0e0">=</span><span> valueFromReducer
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>storeFromReducer </span><span class="token" style="color:#00e0e0">!==</span><span> store </span><span class="token" style="color:#00e0e0">||</span><span> atomFromReducer </span><span class="token" style="color:#00e0e0">!==</span><span> atom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// store或者atom不一致时重新计算值</span><span>
</span><span>    </span><span class="token" style="color:#ffd700">rerender</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    value </span><span class="token" style="color:#00e0e0">=</span><span> store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>  </span><span class="token" style="color:#00e0e0">const</span><span> delay </span><span class="token" style="color:#00e0e0">=</span><span> options</span><span class="token" style="color:#00e0e0">?.</span><span>delay
</span><span>  </span><span class="token" style="color:#ffd700">useEffect</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 订阅后每次修改都会触发该函数，从而调用useReducer的dispatch来更新react组件</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> unsub </span><span class="token" style="color:#00e0e0">=</span><span> store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">sub</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// xxxx</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">rerender</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#ffd700">rerender</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">return</span><span> unsub
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#fefefe">[</span><span>store</span><span class="token" style="color:#fefefe">,</span><span> atom</span><span class="token" style="color:#fefefe">,</span><span> delay</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">)</span><span>
</span>
<span>  </span><span class="token" style="color:#d4d0ab">// xxxx</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">isPromiseLike</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">?</span><span> </span><span class="token" style="color:#ffd700">use</span><span class="token" style="color:#fefefe">(</span><span>value</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token" style="color:#fefefe">(</span><span>value </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token maybe-class-name">Awaited</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span></code></div></pre>
<p>useReducer返回的结果就是 <code>[[value, store, atom], rerender]</code>，其中value为atom的值，store为atom所属的store，rerender是useReducer的dispatch函数(每次value发生改变就会执行rerender来更新组件的值)。</p>
<p>useEffect通过<code>store.sub</code>订阅了atom，当atom的状态更改时触发，然后执行rerender来更新组件的值。<code>store.sub</code>返回取消订阅函数，组件卸载时取消订阅。</p>
<p>可以看出  <code>useAtomValue</code> 主要干了两件事：</p>
<ol>
<li>比较reducer和sore中的值，一致就返回reducer的值，否则返回store中的值</li>
<li>订阅store中atom的状态，来触发reducer的执行。</li>
</ol>
<p>useSetAtom的源码:</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#00e0e0">export</span><span> </span><span class="token" style="color:#00e0e0">function</span><span> </span><span class="token generic-function" style="color:#ffd700">useSetAtom</span><span class="token generic-function generic class-name" style="color:#00e0e0">&lt;</span><span class="token generic-function generic class-name maybe-class-name">Value</span><span class="token generic-function generic class-name" style="color:#fefefe">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name maybe-class-name">Args</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name" style="color:#00e0e0">extends</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name" style="color:#abe338">any</span><span class="token generic-function generic class-name" style="color:#fefefe">[</span><span class="token generic-function generic class-name" style="color:#fefefe">]</span><span class="token generic-function generic class-name" style="color:#fefefe">,</span><span class="token generic-function generic class-name"> </span><span class="token generic-function generic class-name maybe-class-name">Result</span><span class="token generic-function generic class-name" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>  atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">WritableAtom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Args</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Result</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>  options</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Options</span><span>
</span><span></span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> store </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useStore</span><span class="token" style="color:#fefefe">(</span><span>options</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> setAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">useCallback</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">(</span><span class="token spread" style="color:#00e0e0">...</span><span>args</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Args</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// xxx </span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">return</span><span> store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token spread" style="color:#00e0e0">...</span><span>args</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">[</span><span>store</span><span class="token" style="color:#fefefe">,</span><span> atom</span><span class="token" style="color:#fefefe">]</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">return</span><span> setAtom
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span></code></div></pre>
<p>通过<code>store.set</code>设置atom的值。</p>
<h2>store</h2>
<p>store用于保存atom的value，以及atom之间的依赖关系，在Jotai中store是可以通过存在多个，如果没有设置store，会创建一个默认的store。
store有三个常用的方法：</p>
<ul>
<li>get: 获取atom的值，上面 <code>useAtomValue</code> 中使用过</li>
<li>set：设置值，useSetAtom使用来更新atom</li>
<li>sub：订阅atom，atom状态更新时调用
<img src="https://raw.githubusercontent.com/abelce/blogs/master/jotai/upload_fjkayvw2bab4ud43pxtj6z710plmljg9.webp!/fw/850" alt="upload_fjkayvw2bab4ud43pxtj6z710plmljg9.png"/></li>
</ul>
<p>store中atom的依赖关系，atomB可以通过atomA衍生而来，当atomA发生变化时，atomB会自动更新，如下:</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> atomA </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">10</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span></span><span class="token" style="color:#00e0e0">const</span><span> atomB </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">atom</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>get</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>atomA</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// atomA更新时atomB会自动更新</span><span>
</span><span></span><span class="token" style="color:#d4d0ab">// xxxx</span><span>
</span><span>store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>atomA</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>atomB</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>store</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>atomA</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#00e0e0">20</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 更新数据</span></code></div></pre>
<p>store中维护了 atomA与atomB之间的依赖关系：</p>
<ul>
<li>dependency: atomB依赖atomA，atomA是atomB的dependency，维护在atomB的state上(atomState.d中)，原始atom的dependency中有存在atom自身</li>
<li>dependent: atomB依赖atomA，atomB是atomA的dependent中，位置在mounted中（mounted.t中）</li>
</ul>
<p>通过上面的关系，atomA更新时能找到atomB，从而更新atomB的状态。</p>
<p>atom state结构:</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">type</span><span> </span><span class="token class-name maybe-class-name">AtomState</span><span class="token class-name" style="color:#00e0e0">&lt;</span><span class="token class-name maybe-class-name">Value</span><span class="token class-name"> </span><span class="token class-name" style="color:#00e0e0">=</span><span class="token class-name"> </span><span class="token class-name maybe-class-name">AnyValue</span><span class="token class-name" style="color:#00e0e0">&gt;</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  d</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Dependencies</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token" style="color:#00e0e0">&amp;</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">{</span><span> e</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token known-class-name class-name">AnyError</span><span> </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token" style="color:#00e0e0">|</span><span> </span><span class="token" style="color:#fefefe">{</span><span> v</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Value</span><span> </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<ul>
<li>d是维护atom的dependency，<code>type Dependencies = Map&lt;AnyAtom, AtomState&gt;</code></li>
<li>e: 错误信息</li>
<li>v: atom的值</li>
</ul>
<p>Mounted结构，只有在设置atom的值后，才会将</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">type</span><span> </span><span class="token class-name maybe-class-name">Mounted</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  </span><span class="token doc-comment" style="color:#d4d0ab">/** The list of subscriber functions. */</span><span>
</span><span>  l</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Listeners</span><span>
</span><span>  </span><span class="token doc-comment" style="color:#d4d0ab">/** Atoms that depend on *this* atom. Used to fan out invalidation. */</span><span>
</span><span>  t</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Dependents</span><span>
</span><span>  </span><span class="token doc-comment" style="color:#d4d0ab">/** Function to run when the atom is unmounted. */</span><span>
</span><span>  u</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">OnUnmount</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span><span>
</span></code></div></pre>
<ul>
<li>l: atom的监听函数，useAtomValue中通过store.sub订阅的函数存放在这里</li>
<li>t: 维护上面提到的dependent</li>
</ul>
<h3>store.get</h3>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#00e0e0">const</span><span> readAtom </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Value</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span>
</span><span>    </span><span class="token" style="color:#ffd700">returnAtomValue</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#ffd700">readAtomState</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span></code></div></pre>
<p>查找atom的state，并从state中读取value，returnAtomValue:</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> returnAtomValue </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>atomState</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">AtomState</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Value</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>  </span><span class="token" style="color:#d4d0ab">// xxxx</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">return</span><span> atomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">v</span><span>
</span><span></span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>readAtomState源码:</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#00e0e0">const</span><span> readAtomState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">AtomState</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 从atomStateMap获取atom的state</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> atomState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">getAtomState</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>atomState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      atomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">forEach</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>_</span><span class="token" style="color:#fefefe">,</span><span> a</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>a </span><span class="token" style="color:#00e0e0">!==</span><span> atom </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span> </span><span class="token" style="color:#00e0e0">!</span><span>mountedMap</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">has</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// 计算依赖的atomState</span><span>
</span><span>          </span><span class="token" style="color:#ffd700">readAtomState</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// 如果所依赖的所有atom和对应的state没有变化，就直接返回map中的state</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token known-class-name class-name">Array</span><span class="token" style="color:#fefefe">.</span><span class="token module" style="color:#00e0e0">from</span><span class="token" style="color:#fefefe">(</span><span>atomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">every</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>          </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">[</span><span>a</span><span class="token" style="color:#fefefe">,</span><span> s</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> a </span><span class="token" style="color:#00e0e0">===</span><span> atom </span><span class="token" style="color:#00e0e0">||</span><span> </span><span class="token" style="color:#ffd700">getAtomState</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">===</span><span> s
</span><span>        </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">return</span><span> atomState
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// Compute a new state for this atom.</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> nextDependencies</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">NextDependencies</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">new</span><span> </span><span class="token class-name known-class-name">Map</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">let</span><span> isSync </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">true</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> getter</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Getter</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token" style="color:#ffa07a">V</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token" style="color:#ffa07a">V</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>a </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token maybe-class-name">AnyAtom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">===</span><span> atom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 如果依赖的是atom本身，</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> aState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">getAtomState</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 先在atomStateMap上查找state</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>aState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          nextDependencies</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">,</span><span> aState</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>          </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">returnAtomValue</span><span class="token" style="color:#fefefe">(</span><span>aState</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 如果stateMap上没有数据，就返回init</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#ffd700">hasInitialValue</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          nextDependencies</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token nil" style="color:#00e0e0">undefined</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>          </span><span class="token control-flow" style="color:#00e0e0">return</span><span> a</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">init</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// NOTE invalid derived atoms can reach here</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">throw</span><span> </span><span class="token" style="color:#00e0e0">new</span><span> </span><span class="token class-name known-class-name">Error</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#abe338">&#x27;no atom init&#x27;</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// a !== atom</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> aState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">readAtomState</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// 设置依赖</span><span>
</span><span>      nextDependencies</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">set</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">,</span><span> aState</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// 返回a的value</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">returnAtomValue</span><span class="token" style="color:#fefefe">(</span><span>aState</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// xxxxxxxx</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">try</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// 调用read函数，收集依赖和获取value</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> valueOrPromise </span><span class="token" style="color:#00e0e0">=</span><span> atom</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">read</span><span class="token" style="color:#fefefe">(</span><span>getter</span><span class="token" style="color:#fefefe">,</span><span> options </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token" style="color:#abe338">any</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">setAtomValueOrPromise</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> valueOrPromise</span><span class="token" style="color:#fefefe">,</span><span> nextDependencies</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span>
</span><span>        controller</span><span class="token" style="color:#00e0e0">?.</span><span class="token method property-access" style="color:#ffd700">abort</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">catch</span><span> </span><span class="token" style="color:#fefefe">(</span><span>error</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">setAtomError</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> error</span><span class="token" style="color:#fefefe">,</span><span> nextDependencies</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">finally</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      isSync </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">false</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span>
</span></code></div></pre>
<ol>
<li>
<p>如果atomState存在，就遍历atomState.d并获取没有mount的依赖，最后判断每个依赖的state和其最新的state是否相等，相等就表示当前的atom的依赖都没发生变化，所以atomState也没变，返回atomState即可。</p>
</li>
<li>
<p>atomState不存在，执行 atom.read 获取value，同时通过nextDependencies收集依赖</p>
</li>
<li>
<p>如果getter的参数 a=== atom，表示依赖atom本身， 创建atom的时候read不是function，使用默认的read函数<img src="https://raw.githubusercontent.com/abelce/blogs/master/jotai/77280644fdf69943e13f1dac211f69a9.png!/fw/850" alt="77280644fdf69943e13f1dac211f69a9.png"/></p>
</li>
<li>
<p>a !== atom时，获取依赖a的state并起value</p>
</li>
<li>
<p>调用 <code>setAtomValueOrPromise(atom, valueOrPromise, nextDependencies, () =&gt;controller?.abort())</code>，设置atom的value和dependencies。</p>
</li>
</ol>
<p>setAtomValueOrPromise中调用setAtomValue</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#00e0e0">const</span><span> setAtomValueOrPromise </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    valueOrPromise</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Value</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    nextDependencies</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">NextDependencies</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    abortPromise</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#00e0e0">void</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">AtomState</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// .........</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 设置atom的value</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">return</span><span> </span><span class="token" style="color:#ffd700">setAtomValue</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> valueOrPromise</span><span class="token" style="color:#fefefe">,</span><span> nextDependencies</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>继续看setAtomValue</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#00e0e0">const</span><span> setAtomValue </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    value</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Value</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    nextDependencies</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">NextDependencies</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">AtomState</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> prevAtomState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">getAtomState</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> nextAtomState</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">AtomState</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      d</span><span class="token" style="color:#00e0e0">:</span><span> prevAtomState</span><span class="token" style="color:#00e0e0">?.</span><span>d </span><span class="token" style="color:#00e0e0">||</span><span> </span><span class="token" style="color:#00e0e0">new</span><span> </span><span class="token class-name known-class-name">Map</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>      v</span><span class="token" style="color:#00e0e0">:</span><span> value</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>nextDependencies</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">updateDependencies</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> nextAtomState</span><span class="token" style="color:#fefefe">,</span><span> nextDependencies</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>
</span><span>      prevAtomState </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">isEqualAtomValue</span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">,</span><span> nextAtomState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>      prevAtomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span> </span><span class="token" style="color:#00e0e0">===</span><span> nextAtomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// 如果v和d都相等，直接返回以前的state</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// bail out</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">return</span><span> prevAtomState
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>
</span><span>      prevAtomState </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">hasPromiseAtomValue</span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">hasPromiseAtomValue</span><span class="token" style="color:#fefefe">(</span><span>nextAtomState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">isEqualPromiseAtomValue</span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">,</span><span> nextAtomState</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span> </span><span class="token" style="color:#00e0e0">===</span><span> nextAtomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// bail out</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">return</span><span> prevAtomState
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// restore the wrapped promise</span><span>
</span><span>        nextAtomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">v</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> prevAtomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">v</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 设置新的state</span><span>
</span><span>    </span><span class="token" style="color:#ffd700">setAtomState</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> nextAtomState</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">return</span><span> nextAtomState
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span>
</span></code></div></pre>
<p>没有就会创建新的state对象nextAtomState，依赖<code>d</code>默认使用旧的<code>prevAtomState?.d || new Map()</code>，使用nextDependencies更新依赖</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span> </span><span class="token" style="color:#00e0e0">const</span><span> nextAtomState</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">AtomState</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      d</span><span class="token" style="color:#00e0e0">:</span><span> prevAtomState</span><span class="token" style="color:#00e0e0">?.</span><span>d </span><span class="token" style="color:#00e0e0">||</span><span> </span><span class="token" style="color:#00e0e0">new</span><span> </span><span class="token class-name known-class-name">Map</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>      v</span><span class="token" style="color:#00e0e0">:</span><span> value</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>nextDependencies</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#ffd700">updateDependencies</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> nextAtomState</span><span class="token" style="color:#fefefe">,</span><span> nextDependencies</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>下一步比较 prevAtomState 和 nextAtomState，如果<code>v</code>和<code>d</code>都相等，返回 prevAtomState ，否则调用setAtomState更新atomState</p>
<p>setAtomState会将atom的prevAtomState放在pendingMap中，</p>
<h3>store.set</h3>
<p>set过程分为两部分：</p>
<ol>
<li>修改atomState</li>
<li>通过pendingMap刷新依赖中的<code>t</code>(dependent)数据，通过触发通过<code>store.sub</code>的订阅函数</li>
</ol>
<p>writeAtomState函数：</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-ts" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#00e0e0">const</span><span> writeAtomState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Args</span><span> </span><span class="token" style="color:#00e0e0">extends</span><span> </span><span class="token class-name" style="color:#abe338">unknown</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Result</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">WritableAtom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Args</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">Result</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    </span><span class="token spread" style="color:#00e0e0">...</span><span>args</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Args</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Result</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">let</span><span> isSync </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">true</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> getter</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Getter</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token" style="color:#ffa07a">V</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token" style="color:#ffa07a">V</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">returnAtomValue</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#ffd700">readAtomState</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> setter</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Setter</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token" style="color:#ffa07a">V</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">As</span><span> </span><span class="token" style="color:#00e0e0">extends</span><span> </span><span class="token class-name" style="color:#abe338">unknown</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#ffa07a">R</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span> a</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">WritableAtom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token" style="color:#ffa07a">V</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token maybe-class-name">As</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token" style="color:#ffa07a">R</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token spread" style="color:#00e0e0">...</span><span>args</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">As</span><span> </span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">let</span><span> r</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token" style="color:#ffa07a">R</span><span> </span><span class="token" style="color:#00e0e0">|</span><span> </span><span class="token nil" style="color:#00e0e0">undefined</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// 如果修改atom自身的值</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>a </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token maybe-class-name">AnyWritableAtom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">===</span><span> atom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// ......</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> prevAtomState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">getAtomState</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 设置新的value</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> nextAtomState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">setAtomValueOrPromise</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">,</span><span> args</span><span class="token" style="color:#fefefe">[</span><span class="token" style="color:#00e0e0">0</span><span class="token" style="color:#fefefe">]</span><span> </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token" style="color:#ffa07a">V</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#d4d0ab">// 跟store.get过程中一样</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">!</span><span>prevAtomState </span><span class="token" style="color:#00e0e0">||</span><span> </span><span class="token" style="color:#00e0e0">!</span><span class="token" style="color:#ffd700">isEqualAtomValue</span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">,</span><span> nextAtomState</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>           </span><span class="token" style="color:#d4d0ab">// value不相等，重新计算dependents</span><span>
</span><span>          </span><span class="token" style="color:#ffd700">recomputeDependents</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 修改依赖的atom，一直递归到最顶层的原始atom</span><span>
</span><span>        r </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">writeAtomState</span><span class="token" style="color:#fefefe">(</span><span>a </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token maybe-class-name">AnyWritableAtom</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token spread" style="color:#00e0e0">...</span><span>args</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token" style="color:#ffa07a">R</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// 如果atom.write是异步函数</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">!</span><span>isSync</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 刷新pendingMap，重新设置mountedMap中的mounted的t数据</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> flushed </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">flushPending</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// ......</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">return</span><span> r </span><span class="token module" style="color:#00e0e0">as</span><span> </span><span class="token" style="color:#ffa07a">R</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> result </span><span class="token" style="color:#00e0e0">=</span><span> atom</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">write</span><span class="token" style="color:#fefefe">(</span><span>getter</span><span class="token" style="color:#fefefe">,</span><span> setter</span><span class="token" style="color:#fefefe">,</span><span> </span><span class="token spread" style="color:#00e0e0">...</span><span>args</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    isSync </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">false</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">return</span><span> result
</span><span>  </span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>如果更新atom自身，直接通过setAtomValueOrPromise设置新值，然后等信atom的dependent；否则递归调用writeAtomState直到依赖项是原始atom，原始atom更新时就会更新dependent。</p>
<p>flushPending函数：</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-typescript" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>
</span><span>  </span><span class="token" style="color:#00e0e0">const</span><span> flushPending </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token" style="color:#00e0e0">void</span><span> </span><span class="token" style="color:#00e0e0">|</span><span> </span><span class="token known-class-name class-name">Set</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">AnyAtom</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">let</span><span> flushed</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token known-class-name class-name">Set</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">AnyAtom</span><span class="token" style="color:#00e0e0">&gt;</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token module" style="color:#00e0e0">import</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">meta</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">env</span><span class="token" style="color:#00e0e0">?.</span><span class="token" style="color:#ffa07a">MODE</span><span> </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token" style="color:#abe338">&#x27;production&#x27;</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      flushed </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">new</span><span> </span><span class="token class-name known-class-name">Set</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">while</span><span> </span><span class="token" style="color:#fefefe">(</span><span>pendingMap</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">size</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> pending </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token known-class-name class-name">Array</span><span class="token" style="color:#fefefe">.</span><span class="token module" style="color:#00e0e0">from</span><span class="token" style="color:#fefefe">(</span><span>pendingMap</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      pendingMap</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">clear</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      pending</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">forEach</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">[</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> prevAtomState</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> atomState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">getAtomState</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>atomState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>atomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span> </span><span class="token" style="color:#00e0e0">!==</span><span> prevAtomState</span><span class="token" style="color:#00e0e0">?.</span><span>d</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>            </span><span class="token" style="color:#d4d0ab">// 如果依赖不一致，更新依赖</span><span>
</span><span>            </span><span class="token" style="color:#ffd700">mountDependencies</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">,</span><span> atomState</span><span class="token" style="color:#fefefe">,</span><span> prevAtomState</span><span class="token" style="color:#00e0e0">?.</span><span>d</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>          </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>          </span><span class="token" style="color:#00e0e0">const</span><span> mounted </span><span class="token" style="color:#00e0e0">=</span><span> mountedMap</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>          </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>
</span><span>            mounted </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>            </span><span class="token" style="color:#00e0e0">!</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>              </span><span class="token" style="color:#d4d0ab">// TODO This seems pretty hacky. Hope to fix it.</span><span>
</span><span>              </span><span class="token" style="color:#d4d0ab">// Maybe we could `mountDependencies` in `setAtomState`?</span><span>
</span><span>              </span><span class="token" style="color:#fefefe">(</span><span>
</span><span>                prevAtomState </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>                </span><span class="token" style="color:#00e0e0">!</span><span class="token" style="color:#ffd700">hasPromiseAtomValue</span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>                </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#ffd700">isEqualAtomValue</span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">,</span><span> atomState</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#00e0e0">||</span><span>
</span><span>                  </span><span class="token" style="color:#ffd700">isEqualAtomError</span><span class="token" style="color:#fefefe">(</span><span>prevAtomState</span><span class="token" style="color:#fefefe">,</span><span> atomState</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>              </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>            </span><span class="token" style="color:#fefefe">)</span><span>
</span><span>          </span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>            </span><span class="token" style="color:#d4d0ab">// 前后两次state不一致时，触发监听函数（store.sub订阅的回调），调用set方法，组件更新就是这里触发的</span><span>
</span><span>            mounted</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">l</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">forEach</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>listener</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#ffd700">listener</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>            </span><span class="token" style="color:#d4d0ab">// xxxx</span><span>
</span><span>          </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token module" style="color:#00e0e0">import</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">meta</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">env</span><span class="token" style="color:#00e0e0">?.</span><span class="token" style="color:#ffa07a">MODE</span><span> </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token" style="color:#abe338">&#x27;production&#x27;</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// xxx</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// xxx</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>从中可以看到，依赖发生变化时调用<code>mountDependencies</code>函数更新mounted中的<code>t</code>，先从dependents中删除atom，然后将新的atom添加到对应的dependents中。
<code>mountDependencies</code>执行后，通过<code>isEqualAtomValue</code>比较atom的值，如果发生变化就触发监听函数<code>mounted.l.forEach((listener) =&gt; listener())</code>，listener是通过<code>store.sub</code>添加，在<code>useAtomValue</code>就是通过<code>store.sub </code>来触发组件更新。</p>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-typescript" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#00e0e0">const</span><span> mountDependencies </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>    atom</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Atom</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    atomState</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">AtomState</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">Value</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>    prevDependencies</span><span class="token" style="color:#00e0e0">?</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Dependencies</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token" style="color:#00e0e0">void</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> depSet </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">new</span><span> </span><span class="token class-name known-class-name">Set</span><span class="token" style="color:#fefefe">(</span><span>atomState</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">d</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">keys</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    prevDependencies</span><span class="token" style="color:#00e0e0">?.</span><span class="token method property-access" style="color:#ffd700">forEach</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>_</span><span class="token" style="color:#fefefe">,</span><span> a</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>depSet</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">has</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// not changed</span><span>
</span><span>        depSet</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">delete</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">return</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> mounted </span><span class="token" style="color:#00e0e0">=</span><span> mountedMap</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>mounted</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 从被依赖项中的dependent中删除atom，表示不依赖了</span><span>
</span><span>        mounted</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">t</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">delete</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#d4d0ab">// delete from dependents</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#ffd700">canUnmountAtom</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">,</span><span> mounted</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token" style="color:#ffd700">unmountAtom</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 在新的依赖项中添加dependent</span><span>
</span><span>    depSet</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">forEach</span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token arrow" style="color:#00e0e0">=&gt;</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> mounted </span><span class="token" style="color:#00e0e0">=</span><span> mountedMap</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">get</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>mounted</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        mounted</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">t</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">add</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#d4d0ab">// add to dependents</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>mountedMap</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">has</span><span class="token" style="color:#fefefe">(</span><span>atom</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>         </span><span class="token" style="color:#d4d0ab">// xxx</span><span>
</span><span>        </span><span class="token" style="color:#d4d0ab">// 如果a是第一次被依赖，添加新的mounted对象</span><span>
</span><span>        </span><span class="token" style="color:#ffd700">mountAtom</span><span class="token" style="color:#fefefe">(</span><span>a</span><span class="token" style="color:#fefefe">,</span><span> atom</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">)</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span></code></div></pre></div></div></div></div><div class="style_post_notice__eruHe"><div>本文链接: <a href="https://vwood.xyz/blog/705e62c8-4c77-47af-bee2-2cb4eabb7948">https://vwood.xyz/blog/705e62c8-4c77-47af-bee2-2cb4eabb7948</a> </div><div>关于博主: 评论和私信会在第一时间回复</div><div>版权声明: 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</div></div></div></div></div><div class="style_ads__0jIPf"><ins class="adsbygoogle" style="display:block;text-align:center;height:100px" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-6887995008287565" data-ad-slot="2469914690"></ins></div><section class="style_comments__vfE9U"></section></div><div class="style_sidebar__85_45"><div class="style_operator__vQh_M"><div class="style_operator-header__pJr2j"><div><span class="ant-avatar ant-avatar-sm ant-avatar-circle ant-avatar-image"><img src="//file.vwood.xyz/2023/06/11/upload_ssaf3w2dlo0xox7alrcrca1704a6j2fn.jpg!/fw/60"/></span></div><div class="style_operator-header-name-wrapper__OcmjB"><div class="style_operator-name__uEOGB">文钦</div><div class="style_operator-description__sgYiS" title=""></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div><div class="style_item__cXlIc">Github:  <a target="_blank" href="https://github.com/abelce">https://github.com/abelce</a></div><div class="style_item__cXlIc">邮箱:  <a href="mailto:abelce@163.com">abelce@163.com</a></div></div></div><div class="style_latest-article__hK7d9"><h3 class="style_latest-article-header__c8DEW">最新文章</h3><div class="style_latest-article-list__msMMg"><a class="style_article__9q3XZ" title="react动态插入样式" href="/blog/2d304261-a68b-4cf2-bbab-56efec4ba707">react动态插入样式</a><a class="style_article__9q3XZ" title="iframe在react中的使用" href="/blog/6fb6e255-cf4e-46f7-b65a-7ee57793d305">iframe在react中的使用</a><a class="style_article__9q3XZ" title="依赖注入" href="/blog/faa29859-b26c-4737-af1c-f37ff0a7eafc">依赖注入</a><a class="style_article__9q3XZ" title="baseState与baseUpdate.md" href="/blog/fbd908c6-d6e4-4158-9581-fe08ac759e84">baseState与baseUpdate.md</a><a class="style_article__9q3XZ" title="自己打造的react hooks库: let-hooks" href="/blog/8052bec4-7240-4068-864d-243e8b71d918">自己打造的react hooks库: let-hooks</a></div></div></div></div></div></main><footer class="ant-layout-footer"><div class="style_footer__9WRvE"><div>本站由<!-- --> <a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="_blank"><img class="style_upyun__RuV1B" src="/images/又拍云_logo2.png"/></a> <!-- -->提供CDN加速/云存储服务</div></div></footer><div class="ant-back-top"></div></section><div></div><div class="ant-back-top"></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"category":{"id":"6d568d6d-b1ef-4170-8530-3c6199eb0a05","name":"状态管理"},"content":"\n## 介绍\n[Jotai](https://jotai.org/docs/introduction)是一种原子化的状态管理方案。采用的 `Atom` + `hook` + `Context`的方式来解决React的数据管理。\n\n当`Atom`更新的时候不会触发Context的更新，只会更新订阅了`Atom`的组件。\n\nJotai 有一个非常小的 API，并且是面向 TypeScript 的。 它与 React 的集成 useState hook 一样简单易用，但所有状态都是全局可访问的，派生状态易于实现，并且自动消除了额外的重新渲染\n\n同时还提供了`jotai/utils`，这些函数增加了对在 localStorage（或 URL 哈希）中保留原子状态、在服务器端渲染期间混合原子状态、创建具有 set 函数（包括类似 Redux 的 reducers 和 action 类型）的原子等等的支持！\n\n特征:\n  + 核心API只有2KB\n  + 很多的实用工具和集成\n  + 对TypeScript友好\n  + 适用于 Next.js、Gatsby、Remix 和 React Native\n  + 使用 SWC 和 Babel 插件响应快速刷新\n\n本文基于jotai v2.2.1版本。\n\n## 使用\n\n[例子](https://github.com/pmndrs/jotai/tree/main/examples)\n\n#### 创建atom\n\n```ts\nimport { atom } from 'jotai'\n\nconst countAtom = atom(0)\n```\n\n在组件中使用\n```tsx\nimport { useAtom } from 'jotai'\n\nfunction Counter() {\n  const [count, setCount] = useAtom(countAtom)\n  return (\n    \u003ch1\u003e\n      {count}\n      \u003cbutton onClick={() =\u003e setCount((c) =\u003e c + 1)}\u003eadd\u003c/button\u003e\n    \u003c/h1\u003e\n    )\n}\n```\n\n#### 衍生atom\n\n```tsx\nconst doubledCountAtom = atom((get) =\u003e get(countAtom) * 2)\n\nfunction DoubleCounter() {\n  const [doubledCount] = useAtom(doubledCountAtom)\n  return \u003ch2\u003e{doubledCount}\u003c/h2\u003e\n}\n```\n从多个atom衍生\n\n```ts\nconst count1 = atom(1)\nconst count2 = atom(2)\nconst count3 = atom(3)\n\nconst sum = atom((get) =\u003e get(count1) + get(count2) + get(count3))\n```\n\n#### 可读可写atom\n默认atom就是可读可写的\n\n```ts\nconst decrementCountAtom = atom(\n  (get) =\u003e get(countAtom),\n  (get, set, _arg) =\u003e set(countAtom, get(countAtom) - 1)\n)\n```\n\n#### 只读atom\n\n```ts\nconst readOnlyAtom = atom((get) =\u003e get(countAtom) * 2)\n```\n\n#### 只写atom\n\n```ts\nconst multiplyCountAtom = atom(null, (get, set, by) =\u003e\n  set(countAtom, get(countAtom) * by)\n)\n```\n\n#### useAtomValue\n获取atom的值\n```ts\nconst count = useAtomValue(countAtom)\n```\n\n#### useSetAtom\n设置atom的值\n```ts\nconst setCount = useSetAtom(countAtom)\n```\n\n## 工具函数\nJotai提供了一些使用的工具函数，方便业务使用。\n### 本地存储 [atomWithStorage](https://jotai.org/docs/utilities/storage)\n支持将数据持久化到本地\n\n[在线例子](https://codesandbox.io/s/jotai-persistence-vuwi7?from-embed=\u0026file=/src/app.js:181-196)\n\n### 缓存 [atomFamily](https://jotai.org/docs/utilities/family)\n使用atomFamily复用已存在的atom \n\n### 数组 [splitAtom](https://jotai.org/docs/utilities/split)\n对数据项自动进行atom包装，同时提供了`remove`、`insert`和`move`操作\n\n## atom\natom函数用于创建atom配置，紧紧只是一个配置对象，不保存atom的值(原始atom会将默认值保存在init中)，atom对象是不可变的，值保存在store中，通过`store.get`获取\n\n```ts\nconst countAtom = atom(10);\n```\n\natom源码:\n\n```ts\nexport function atom\u003cValue, Args extends unknown[], Result\u003e(\n  read: Value | Read\u003cValue, SetAtom\u003cArgs, Result\u003e\u003e,\n  write?: Write\u003cArgs, Result\u003e\n) {\n  // atom的key，可以在React中作为组件的key使用\n  const key = `atom${++keyCount}`\n  const config = {\n    toString: () =\u003e key,\n  }\n  if (typeof read === 'function') {\n    // read是函数表示是一个衍生的atom\n    config.read = read\n  } else {\n    // read为非函数类型\n    config.init = read\n    config.read = (get) =\u003e get(config)\n    // 设置默认的write，设置当前atom的值\n    config.write = ((get: Getter, set: Setter, arg: SetStateAction\u003cValue\u003e) =\u003e\n      set(config, typeof arg === 'function' ? arg(get(config)) : arg))\n  }\n  if (write) {\n    // 覆盖默认的write\n    config.write = write\n  }\n  return config\n}\n\n```\n上面的代码可以看出atom的一些特征：\n1. 每个atom都有一个唯一的`key`，并重写了config的toString方法（可以直接在React组件中将atom作为key使用）。\n2. read参数不为函数时，设置默认的read=(get) =\u003e get(config)读取atom自身的值。\n3. atom默认的`write`函数是修改自身的值，所以原始atom是可读可写的，衍生的atom没有没有默认write方法。\n4. 原始atom的初始值保存在`init`中，并且不能修改。\n\n\n## useAtom\n\nuseAtom使用atom与store结合起来的桥梁,使用 `useAtomValue`读取值、`useSetAtom`设置atom的值\n![upload_tilhjximg25aw5dm3pdm4zzl6o9302ye.webp](https://raw.githubusercontent.com/abelce/blogs/master/jotai/upload_tilhjximg25aw5dm3pdm4zzl6o9302ye.webp)\n\n\nuseAtomValue代码如下：\n\n```ts\nexport function useAtomValue\u003cValue\u003e(atom: Atom\u003cValue\u003e, options?: Options) {\n  const store = useStore(options)\n  \n  const [[valueFromReducer, storeFromReducer, atomFromReducer], rerender] = useReducer(\n      (prev) =\u003e {\n        const nextValue = store.get(atom)\n        if (\n          Object.is(prev[0], nextValue) \u0026\u0026\n          prev[1] === store \u0026\u0026\n          prev[2] === atom\n        ) {\n          // 如果前后两次value、store、atom都一样，返回上一次修改的值\n          return prev\n        }\n        return [nextValue, store, atom]\n      },\n      undefined,\n      () =\u003e [store.get(atom), store, atom]\n    )\n\n  let value = valueFromReducer\n  if (storeFromReducer !== store || atomFromReducer !== atom) {\n    // store或者atom不一致时重新计算值\n    rerender()\n    value = store.get(atom)\n  }\n\n  const delay = options?.delay\n  useEffect(() =\u003e {\n    // 订阅后每次修改都会触发该函数，从而调用useReducer的dispatch来更新react组件\n    const unsub = store.sub(atom, () =\u003e {\n      // xxxx\n      rerender()\n    })\n    rerender()\n    return unsub\n  }, [store, atom, delay])\n\n  // xxxx\n  return isPromiseLike(value) ? use(value) : (value as Awaited\u003cValue\u003e)\n}\n\n```\n\nuseReducer返回的结果就是 `[[value, store, atom], rerender]`，其中value为atom的值，store为atom所属的store，rerender是useReducer的dispatch函数(每次value发生改变就会执行rerender来更新组件的值)。\n\nuseEffect通过`store.sub`订阅了atom，当atom的状态更改时触发，然后执行rerender来更新组件的值。`store.sub`返回取消订阅函数，组件卸载时取消订阅。\n\n可以看出  `useAtomValue` 主要干了两件事：\n\n1. 比较reducer和sore中的值，一致就返回reducer的值，否则返回store中的值\n2. 订阅store中atom的状态，来触发reducer的执行。\n\n\nuseSetAtom的源码:\n```ts\nexport function useSetAtom\u003cValue, Args extends any[], Result\u003e(\n  atom: WritableAtom\u003cValue, Args, Result\u003e,\n  options?: Options\n) {\n  const store = useStore(options)\n  const setAtom = useCallback(\n    (...args: Args) =\u003e {\n      // xxx \n      return store.set(atom, ...args)\n    },\n    [store, atom]\n  )\n  return setAtom\n}\n\n```\n通过`store.set`设置atom的值。\n\n\n## store\nstore用于保存atom的value，以及atom之间的依赖关系，在Jotai中store是可以通过存在多个，如果没有设置store，会创建一个默认的store。\nstore有三个常用的方法：\n\n+ get: 获取atom的值，上面 `useAtomValue` 中使用过\n+ set：设置值，useSetAtom使用来更新atom\n+ sub：订阅atom，atom状态更新时调用\n![upload_fjkayvw2bab4ud43pxtj6z710plmljg9.png](https://raw.githubusercontent.com/abelce/blogs/master/jotai/upload_fjkayvw2bab4ud43pxtj6z710plmljg9.webp)\n\n\nstore中atom的依赖关系，atomB可以通过atomA衍生而来，当atomA发生变化时，atomB会自动更新，如下:\n\n```ts\nconst atomA = atom(10);\nconst atomB = atom((get) =\u003e get(atomA)); // atomA更新时atomB会自动更新\n// xxxx\nstore.get(atomA)\nstore.get(atomB);\nstore.set(atomA, 20); // 更新数据\n```\n\nstore中维护了 atomA与atomB之间的依赖关系：\n\n+ dependency: atomB依赖atomA，atomA是atomB的dependency，维护在atomB的state上(atomState.d中)，原始atom的dependency中有存在atom自身\n+ dependent: atomB依赖atomA，atomB是atomA的dependent中，位置在mounted中（mounted.t中）\n\n通过上面的关系，atomA更新时能找到atomB，从而更新atomB的状态。\n\natom state结构:\n\n```ts\ntype AtomState\u003cValue = AnyValue\u003e = {\n  d: Dependencies\n} \u0026 ({ e: AnyError } | { v: Value })\n```\n\n+ d是维护atom的dependency，`type Dependencies = Map\u003cAnyAtom, AtomState\u003e`\n+ e: 错误信息\n+ v: atom的值\n\nMounted结构，只有在设置atom的值后，才会将\n```ts\ntype Mounted = {\n  /** The list of subscriber functions. */\n  l: Listeners\n  /** Atoms that depend on *this* atom. Used to fan out invalidation. */\n  t: Dependents\n  /** Function to run when the atom is unmounted. */\n  u?: OnUnmount\n}\n\n```\n\n+ l: atom的监听函数，useAtomValue中通过store.sub订阅的函数存放在这里\n+ t: 维护上面提到的dependent\n\n\n\n### store.get\n\n\n```ts\n  const readAtom = \u003cValue\u003e(atom: Atom\u003cValue\u003e): Value =\u003e\n    returnAtomValue(readAtomState(atom))\n```\n\n查找atom的state，并从state中读取value，returnAtomValue:\n\n```ts\nconst returnAtomValue = \u003cValue\u003e(atomState: AtomState\u003cValue\u003e): Value =\u003e {\n  // xxxx\n  return atomState.v\n}\n```\n\nreadAtomState源码:\n\n```ts\nconst readAtomState = \u003cValue\u003e(atom: Atom\u003cValue\u003e): AtomState\u003cValue\u003e =\u003e {\n    // 从atomStateMap获取atom的state\n    const atomState = getAtomState(atom)\n    if (atomState) {\n      atomState.d.forEach((_, a) =\u003e {\n        if (a !== atom \u0026\u0026 !mountedMap.has(a)) {\n          // 计算依赖的atomState\n          readAtomState(a)\n        }\n      })\n      // 如果所依赖的所有atom和对应的state没有变化，就直接返回map中的state\n      if (Array.from(atomState.d).every(\n          ([a, s]) =\u003e a === atom || getAtomState(a) === s\n        )) {\n        return atomState\n      }\n    }\n    // Compute a new state for this atom.\n    const nextDependencies: NextDependencies = new Map()\n    let isSync = true\n    const getter: Getter = \u003cV\u003e(a: Atom\u003cV\u003e) =\u003e {\n      if ((a as AnyAtom) === atom) {\n        // 如果依赖的是atom本身，\n        const aState = getAtomState(a)\n        // 先在atomStateMap上查找state\n        if (aState) {\n          nextDependencies.set(a, aState)\n          return returnAtomValue(aState)\n        }\n        // 如果stateMap上没有数据，就返回init\n        if (hasInitialValue(a)) {\n          nextDependencies.set(a, undefined)\n          return a.init\n        }\n        // NOTE invalid derived atoms can reach here\n        throw new Error('no atom init')\n      }\n      // a !== atom\n      const aState = readAtomState(a)\n      // 设置依赖\n      nextDependencies.set(a, aState)\n      // 返回a的value\n      return returnAtomValue(aState)\n    }\n    // xxxxxxxx\n    try {\n      // 调用read函数，收集依赖和获取value\n      const valueOrPromise = atom.read(getter, options as any)\n      return setAtomValueOrPromise(atom, valueOrPromise, nextDependencies, () =\u003e\n        controller?.abort()\n      )\n    } catch (error) {\n      return setAtomError(atom, error, nextDependencies)\n    } finally {\n      isSync = false\n    }\n  }\n\n```\n\n1. 如果atomState存在，就遍历atomState.d并获取没有mount的依赖，最后判断每个依赖的state和其最新的state是否相等，相等就表示当前的atom的依赖都没发生变化，所以atomState也没变，返回atomState即可。\n\n2. atomState不存在，执行 atom.read 获取value，同时通过nextDependencies收集依赖\n\n  1. 如果getter的参数 a=== atom，表示依赖atom本身， 创建atom的时候read不是function，使用默认的read函数![77280644fdf69943e13f1dac211f69a9.png](https://raw.githubusercontent.com/abelce/blogs/master/jotai/77280644fdf69943e13f1dac211f69a9.png)\n\n  2. a !== atom时，获取依赖a的state并起value\n\n3. 调用 `setAtomValueOrPromise(atom, valueOrPromise, nextDependencies, () =\u003econtroller?.abort())`，设置atom的value和dependencies。\n\nsetAtomValueOrPromise中调用setAtomValue\n\n```ts\n  const setAtomValueOrPromise = \u003cValue\u003e(\n    atom: Atom\u003cValue\u003e,\n    valueOrPromise: Value,\n    nextDependencies?: NextDependencies,\n    abortPromise?: () =\u003e void\n  ): AtomState\u003cValue\u003e =\u003e {\n    // .........\n    // 设置atom的value\n    return setAtomValue(atom, valueOrPromise, nextDependencies)\n  }\n```\n\n继续看setAtomValue\n\n```ts\n  const setAtomValue = \u003cValue\u003e(\n    atom: Atom\u003cValue\u003e,\n    value: Value,\n    nextDependencies?: NextDependencies\n  ): AtomState\u003cValue\u003e =\u003e {\n    const prevAtomState = getAtomState(atom)\n    const nextAtomState: AtomState\u003cValue\u003e = {\n      d: prevAtomState?.d || new Map(),\n      v: value,\n    }\n    if (nextDependencies) {\n      updateDependencies(atom, nextAtomState, nextDependencies)\n    }\n    if (\n      prevAtomState \u0026\u0026\n      isEqualAtomValue(prevAtomState, nextAtomState) \u0026\u0026\n      prevAtomState.d === nextAtomState.d\n    ) {\n      // 如果v和d都相等，直接返回以前的state\n      // bail out\n      return prevAtomState\n    }\n    if (\n      prevAtomState \u0026\u0026\n      hasPromiseAtomValue(prevAtomState) \u0026\u0026\n      hasPromiseAtomValue(nextAtomState) \u0026\u0026\n      isEqualPromiseAtomValue(prevAtomState, nextAtomState)\n    ) {\n      if (prevAtomState.d === nextAtomState.d) {\n        // bail out\n        return prevAtomState\n      } else {\n        // restore the wrapped promise\n        nextAtomState.v = prevAtomState.v\n      }\n    }\n    // 设置新的state\n    setAtomState(atom, nextAtomState)\n    return nextAtomState\n  }\n\n```\n\n没有就会创建新的state对象nextAtomState，依赖`d`默认使用旧的`prevAtomState?.d || new Map()`，使用nextDependencies更新依赖\n\n```ts\n const nextAtomState: AtomState\u003cValue\u003e = {\n      d: prevAtomState?.d || new Map(),\n      v: value,\n    }\n    if (nextDependencies) {\n      updateDependencies(atom, nextAtomState, nextDependencies)\n    }\n```\n\n下一步比较 prevAtomState 和 nextAtomState，如果`v`和`d`都相等，返回 prevAtomState ，否则调用setAtomState更新atomState\n\nsetAtomState会将atom的prevAtomState放在pendingMap中，\n\n\n\n### store.set\n\nset过程分为两部分：\n\n1. 修改atomState\n2. 通过pendingMap刷新依赖中的`t`(dependent)数据，通过触发通过`store.sub`的订阅函数\n\n\nwriteAtomState函数：\n\n```ts\n  const writeAtomState = \u003cValue, Args extends unknown[], Result\u003e(\n    atom: WritableAtom\u003cValue, Args, Result\u003e,\n    ...args: Args\n  ): Result =\u003e {\n    let isSync = true\n    const getter: Getter = \u003cV\u003e(a: Atom\u003cV\u003e) =\u003e returnAtomValue(readAtomState(a))\n    const setter: Setter = \u003cV, As extends unknown[], R\u003e( a: WritableAtom\u003cV, As, R\u003e, ...args: As ) =\u003e {\n      let r: R | undefined\n      // 如果修改atom自身的值\n      if ((a as AnyWritableAtom) === atom) {\n        // ......\n        const prevAtomState = getAtomState(a)\n        // 设置新的value\n        const nextAtomState = setAtomValueOrPromise(a, args[0] as V)// 跟store.get过程中一样\n        if (!prevAtomState || !isEqualAtomValue(prevAtomState, nextAtomState)) {\n           // value不相等，重新计算dependents\n          recomputeDependents(a)\n        }\n      } else {\n        // 修改依赖的atom，一直递归到最顶层的原始atom\n        r = writeAtomState(a as AnyWritableAtom, ...args) as R\n      }\n      // 如果atom.write是异步函数\n      if (!isSync) {\n        // 刷新pendingMap，重新设置mountedMap中的mounted的t数据\n        const flushed = flushPending()\n        // ......\n      }\n      return r as R\n    }\n    const result = atom.write(getter, setter, ...args)\n    isSync = false\n    return result\n  }\n```\n\n如果更新atom自身，直接通过setAtomValueOrPromise设置新值，然后等信atom的dependent；否则递归调用writeAtomState直到依赖项是原始atom，原始atom更新时就会更新dependent。\n\nflushPending函数：\n```typescript\n\n  const flushPending = (): void | Set\u003cAnyAtom\u003e =\u003e {\n    let flushed: Set\u003cAnyAtom\u003e\n    if (import.meta.env?.MODE !== 'production') {\n      flushed = new Set()\n    }\n    while (pendingMap.size) {\n      const pending = Array.from(pendingMap)\n      pendingMap.clear()\n      pending.forEach(([atom, prevAtomState]) =\u003e {\n        const atomState = getAtomState(atom)\n        if (atomState) {\n          if (atomState.d !== prevAtomState?.d) {\n            // 如果依赖不一致，更新依赖\n            mountDependencies(atom, atomState, prevAtomState?.d)\n          }\n          const mounted = mountedMap.get(atom)\n          if (\n            mounted \u0026\u0026\n            !(\n              // TODO This seems pretty hacky. Hope to fix it.\n              // Maybe we could `mountDependencies` in `setAtomState`?\n              (\n                prevAtomState \u0026\u0026\n                !hasPromiseAtomValue(prevAtomState) \u0026\u0026\n                (isEqualAtomValue(prevAtomState, atomState) ||\n                  isEqualAtomError(prevAtomState, atomState))\n              )\n            )\n          ) {\n            // 前后两次state不一致时，触发监听函数（store.sub订阅的回调），调用set方法，组件更新就是这里触发的\n            mounted.l.forEach((listener) =\u003e listener())\n            // xxxx\n          }\n        } else if (import.meta.env?.MODE !== 'production') {\n          // xxx\n        }\n      })\n    }\n    // xxx\n  }\n```\n\n从中可以看到，依赖发生变化时调用`mountDependencies`函数更新mounted中的`t`，先从dependents中删除atom，然后将新的atom添加到对应的dependents中。\n`mountDependencies`执行后，通过`isEqualAtomValue`比较atom的值，如果发生变化就触发监听函数`mounted.l.forEach((listener) =\u003e listener())`，listener是通过`store.sub`添加，在`useAtomValue`就是通过`store.sub `来触发组件更新。\n\n```typescript\n  const mountDependencies = \u003cValue\u003e(\n    atom: Atom\u003cValue\u003e,\n    atomState: AtomState\u003cValue\u003e,\n    prevDependencies?: Dependencies\n  ): void =\u003e {\n    const depSet = new Set(atomState.d.keys())\n    prevDependencies?.forEach((_, a) =\u003e {\n      if (depSet.has(a)) {\n        // not changed\n        depSet.delete(a)\n        return\n      }\n      const mounted = mountedMap.get(a)\n      if (mounted) {\n        // 从被依赖项中的dependent中删除atom，表示不依赖了\n        mounted.t.delete(atom) // delete from dependents\n        if (canUnmountAtom(a, mounted)) {\n          unmountAtom(a)\n        }\n      }\n    })\n    // 在新的依赖项中添加dependent\n    depSet.forEach((a) =\u003e {\n      const mounted = mountedMap.get(a)\n      if (mounted) {\n        mounted.t.add(atom) // add to dependents\n      } else if (mountedMap.has(atom)) {\n         // xxx\n        // 如果a是第一次被依赖，添加新的mounted对象\n        mountAtom(a, atom)\n      }\n    })\n  }\n```\n","createTime":1692453681241,"creativeType":"original","description":"\n 介绍\n[Jotai](https:jotai.org/docs/introduction)是一种原子化的状态管理方案。采用的 Atom + hook + Context的方式来解决React的数据管理。\n\n当Atom更新的时候不会触发Context的更新，只会更新订阅了Atom的组件。\n\nJotai 有一个非常小的 API，并且是面向 TypeScript 的。 它","headerImg":"//file.vwood.xyz/2023/08/20/upload_sv0wcr8j84x8y9atlbdl8yhz6w85vpgs.png","id":"705e62c8-4c77-47af-bee2-2cb4eabb7948","isDeleted":false,"likeCount":0,"name":"jotai原理篇","operator":{"avatar":"//file.vwood.xyz/2023/06/11/upload_ssaf3w2dlo0xox7alrcrca1704a6j2fn.jpg","description":"","email":"abelce@163.com","github":"https://github.com/abelce","id":"96f16846-31f2-489c-9af0-d4ca13e836e4","name":"文钦"},"operatorID":"96f16846-31f2-489c-9af0-d4ca13e836e4","tags":["jotai","状态管理"],"updateTime":1699773548753,"viewCount":0},"id":"705e62c8-4c77-47af-bee2-2cb4eabb7948","latestArticleList":[{"id":"2d304261-a68b-4cf2-bbab-56efec4ba707","name":"react动态插入样式","tags":[],"description":"","content":""},{"id":"6fb6e255-cf4e-46f7-b65a-7ee57793d305","name":"iframe在react中的使用","tags":[],"description":"","content":""},{"id":"faa29859-b26c-4737-af1c-f37ff0a7eafc","name":"依赖注入","tags":[],"description":"","content":""},{"id":"fbd908c6-d6e4-4158-9581-fe08ac759e84","name":"baseState与baseUpdate.md","tags":[],"description":"","content":""},{"id":"8052bec4-7240-4068-864d-243e8b71d918","name":"自己打造的react hooks库: let-hooks","tags":[],"description":"","content":""}]},"initialMobxState":{"userStore":{"currentUser":null,"users":[],"token":"","qiniuToken":"","userCount":0,"productCount":0,"commentCount":0,"settingType":"products"},"productStore":{"products":[],"total":0,"type":"","url":"","current":1,"product":null,"likesMap":{},"tabpane":"all","token":"","loading":false,"todayHunters":[],"today":[],"yesterday":[],"relatedProducts":[],"search":""},"commentStore":{"comments":[],"total":0,"current":0},"noteStore":{"token":"","notes":[],"total":0,"note":null},"askStore":{"token":"","asks":[],"total":0,"ask":null},"stypeStore":{"data":[]}},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"705e62c8-4c77-47af-bee2-2cb4eabb7948"},"buildId":"kixI1C9mn6Usu_fHeTZRq","isFallback":false,"gsp":true,"appGip":true,"scriptLoader":[]}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-MMNJYR8ESW" crossorigin="anonymous" strategy="lazyOnload"></script><script>window.dataLayer = window.dataLayer || [];
              function gtag(){window.dataLayer.push(arguments)}
              gtag('js', new Date());
              gtag('config', 'G-MMNJYR8ESW');</script><script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.async=true
              hm.src = "https://hm.baidu.com/hm.js?ea0272238080a1dedd4e077d19445ced";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
            })();
            </script></body></html>