<!DOCTYPE html><html lang="zh-Hans"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,maximum-scale=1.0,viewport-fit=cover"/><title>baseState与baseUpdate.md<!-- --> - <!-- -->文钦的个人日志</title><meta name="keywords" content="react,baseState,updateQueue"/><meta name="description" content="本文介绍React更新的baseState，阐述baseState在updateQueue中的作用，以及工作原理。

首先React中任务有着不同的优先级，优先级高的任务先执行，低的后执行。所以会出现先创建的任务后执行的情况。比如下面的例子：

A1 -B2 -&gt; C1 -&gt; D2

其中数字越小优先级越高，所以A1和C1 会优先执行，执行完后的更新队列就如下：

B"/><meta property="og:title" content="baseState与baseUpdate.md - 文钦的个人日志"/><meta property="og:url" content="https://vwood.xyz/blog/fbd908c6-d6e4-4158-9581-fe08ac759e84"/><meta name="next-head-count" content="8"/><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/><meta http-equiv="Cache-Control" content="no-siteapp"/><link rel="icon" href="/favicon.ico"/><meta name="author" content="文钦,1061225829@qq.com"/><meta property="site_name" content="文钦的个人日志"/><meta name="google-site-verification" content="LE9f0-2YGlWDKgo5955hV_-oeN3Uq74EN_6gcKaJ60U"/><meta property="og:type" content="website"/><meta property="og:site_name" content="文钦的个人日志"/><link rel="dns-prefetch" href="cdn.vwood.xyz"/><link rel="dns-prefetch" href="cloud.vwood.xyz"/><link rel="dns-prefetch" href="file.vwood.xyz"/><meta name="msvalidate.01" content="3E915E4B19B295BCF5E1FEB5AA8367EB"/><meta name="baidu_union_verify" content="a673bc08063b1108073e80d745c6be14"/><meta name="baidu-site-verification" content="codeva-Dibq943E2F"/><meta name="360-site-verification" content="3a57e570191c7aa35ea273b1dc587150"/><meta name="sogou_site_verification" content="li0U6hc1gz"/><meta name="theme-color" content="#ffffff"/><link rel="preload" href="/_next/static/css/b627b0b392279b61.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b627b0b392279b61.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6dd63efe9eb313a8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6dd63efe9eb313a8.css" data-n-p=""/><link rel="preload" href="/_next/static/css/0b4c08f05448376e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0b4c08f05448376e.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-6bc49c9db4d724a3.js" defer=""></script><script src="/_next/static/chunks/framework-beeb81ad8570a989.js" defer=""></script><script src="/_next/static/chunks/main-2c5c31b519427824.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1204e3a4dfe4fcd0.js" defer=""></script><script src="/_next/static/chunks/175675d1-62aa9bb626fe4428.js" defer=""></script><script src="/_next/static/chunks/61-0bc427fa690628ba.js" defer=""></script><script src="/_next/static/chunks/305-ee87e158bd818b49.js" defer=""></script><script src="/_next/static/chunks/51-350cf45767b4e10a.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-59d9c9dd105f5a35.js" defer=""></script><script src="/_next/static/DO1R4oWI773V9D4_4YIM0/_buildManifest.js" defer=""></script><script src="/_next/static/DO1R4oWI773V9D4_4YIM0/_ssgManifest.js" defer=""></script></head><body class="custom_class"><div id="__next"><section class="ant-layout ant-layout-has-sider style_layout__lI5tQ" id="layout"><header class="ant-layout-header"><div class="style_header__ScyKA"><nav class="style_header_left__MwL2y"><a class="style_logo-container__V_i5n" href="/"><img alt="logo" src="/images/logo.png"/><h3>文钦的个人日志</h3></a><ul class="ant-menu-overflow ant-menu ant-menu-root ant-menu-horizontal ant-menu-light style_navs__cT4uk" role="menu" tabindex="0" data-menu-list="true"><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:0" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/">首页</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:1" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/tools">工具</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:2" role="menuitem" tabindex="-1" value="_blank"><span class="ant-menu-title-content"><a target="_blank" href="https://let-hooks.vwood.xyz">Hooks</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:3" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/my-recommend">好文推荐</a></span></li><li class="ant-menu-overflow-item ant-menu-item ant-menu-item-only-child style_nav-item__36GBG" style="opacity:1;order:4" role="menuitem" tabindex="-1"><span class="ant-menu-title-content"><a href="/about">关于</a></span></li><li class="ant-menu-overflow-item ant-menu-overflow-item-rest ant-menu-submenu ant-menu-submenu-horizontal" style="opacity:0;height:0;overflow-y:hidden;order:9007199254740991;pointer-events:none;position:absolute" aria-hidden="true" role="none"><div role="menuitem" class="ant-menu-submenu-title" tabindex="-1" aria-expanded="false" aria-haspopup="true"><span role="img" aria-label="ellipsis" class="anticon anticon-ellipsis"><svg viewBox="64 64 896 896" focusable="false" data-icon="ellipsis" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M176 511a56 56 0 10112 0 56 56 0 10-112 0zm280 0a56 56 0 10112 0 56 56 0 10-112 0zm280 0a56 56 0 10112 0 56 56 0 10-112 0z"></path></svg></span><i class="ant-menu-submenu-arrow"></i></div></li></ul><div style="display:none" aria-hidden="true"></div></nav><div class="style_header_right__pnukD"><div class="style_ads__bENq0"><ins class="adsbygoogle" style="display:inline-block;text-align:center;width:400px;height:60px" data-ad-layout="in-header" data-ad-format="fluid" data-ad-client="ca-pub-6887995008287565" data-ad-slot="8657788489" data-full-width-responsive="true"></ins></div><span role="img" aria-label="menu" tabindex="-1" class="anticon anticon-menu style_menu-icon__3wbdv"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><main class="ant-layout-content style_layout-content__nrtXO"><div class="style_detail_container__K7ALK"><div class="style_main__tK6AF"><div class="style_content__Gif1x"><div class="style_post_container__Ayu6o"><div class="style_post__dVMJC"><div class="style_post_content__sRh5M"><div class="style_post_header__kL41j"><h1 class="style_name__yhPOn" title="baseState与baseUpdate.md">baseState与baseUpdate.md</h1><div class="style_base-info__fcDVY"><span class="style_item__VwCzm"><i class="iconfont"></i><span>这篇文章发表于 <span>2023年10月18日，星期三，22:29</span></span><div class="ant-divider ant-divider-vertical" role="separator"></div></span><div><button type="button" class="ant-btn ant-btn-link ant-btn-sm"><span>分享</span></button></div></div></div><div><div class="style_content__Gif1x"><div class="style_marked__AZOQ3"><div class="markdown-body"><p>本文介绍React更新的baseState，阐述baseState在updateQueue中的作用，以及工作原理。</p>
<p>首先React中任务有着不同的优先级，优先级高的任务先执行，低的后执行。所以会出现先创建的任务后执行的情况。比如下面的例子：</p>
<pre><code>A1 -&gt; B2 -&gt; C1 -&gt; D2
</code></pre>
<p>其中数字越小优先级越高，所以<code>A1</code>和<code>C1</code> 会优先执行，执行完后的更新队列就如下：</p>
<pre><code>B2 -&gt; D2
</code></pre>
<p>假如每个任务对state的操作为如下：</p>
<pre><code>const [count, setCount] = useState(1)
A1: setCount(count =&gt; count + 1)
B2: setCount(count =&gt; count * 2)
C1: setCount(count =&gt; count + 1)
D2: setCount(count =&gt; count + 2)
</code></pre>
<p>首先如果不按照优先级，直接按照更新列表中任务的顺序执行，执行的过程就是</p>
<pre><code>A: count = 1 + 1; //2
B: count = 2 * 2; // 4
C: count = 4 + 1; // 5
D: count = 5 + 2; // 7
</code></pre>
<p>上面的执行结果为<code>count=7</code></p>
<p>如果按照优先级高的先执行，优先级低的后执行那么执行的顺序如下:</p>
<pre><code>// 高优先级
A1: count = 1 + 1; // 2
C1: count = 2 + 1; // 3
// 低优先级
B2: count = 3 * 2; // 6
D2: count = 6 + 2; // 8
</code></pre>
<p>执行结果为<code>count=8</code>，两种方式的执行结果竟然不一致。</p>
<p>那么React时是怎么解决这个问题的呢?</p>
<p>往下看。</p>
<h2>baseState和baseUpdate</h2>
<p>react在 updateQueue上用<code>baseState</code>、<code>firstBaseUpdate</code>、<code>lastBaseUpdate</code>来解决。</p>
<p>这三个属性的作用：</p>
<ol>
<li>baseState：第一个被跳过的Update前一个Update的执行结果。</li>
<li>firstBaseUpdate：第一个被跳过的Update</li>
<li>lastBaseUpdate：最后一个Update，只要有Update被跳过，那么该元素就指向updateQueue的最后一个节点。</li>
</ol>
<p>下面看一下processUpdateQueue源码的执行逻辑。</p>
<h3>将新的update追加到现有的baseUpdate后面</h3>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>  </span><span class="token" style="color:#00e0e0">const</span><span> </span><span class="token literal-property" style="color:#ffa07a">queue</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">State</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>workInProgress</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">updateQueue</span><span class="token" style="color:#00e0e0">:</span><span> any</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>  hasForceUpdate </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#00e0e0">false</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>  </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>__DEV__</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    currentlyProcessingQueue </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">shared</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>  </span><span class="token" style="color:#00e0e0">let</span><span> firstBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">firstBaseUpdate</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 上次执行后的第一个baseUpdate</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">let</span><span> lastBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lastBaseUpdate</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 上次执行后的最后一个</span><span>
</span>
<span>  </span><span class="token" style="color:#d4d0ab">// Check if there are pending updates. If so, transfer them to the base queue.</span><span>
</span><span>  </span><span class="token" style="color:#00e0e0">let</span><span> pendingQueue </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">shared</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">pending</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 本次待处理的update</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>pendingQueue </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span>    
<span>    queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">shared</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">pending</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d4d0ab">// The pending queue is circular. Disconnect the pointer between first</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// and last so that it&#x27;s non-circular.</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> lastPendingUpdate </span><span class="token" style="color:#00e0e0">=</span><span> pendingQueue</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> firstPendingUpdate </span><span class="token" style="color:#00e0e0">=</span><span> lastPendingUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    lastPendingUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">     * 将pending update 追加到 base update上 
</span><span class="token doc-comment" style="color:#d4d0ab">     * */</span><span> 
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>lastBaseUpdate </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">       * 如果baseUpdate没有数据，就是说上一次没有出现跳过某个update的情况，那么就将 firstBaseUpdate就为pendingUpdate的第一个节点 
</span><span class="token doc-comment" style="color:#d4d0ab">       */</span><span>
</span><span>      firstBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> firstPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      lastBaseUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> firstPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">     * lastBaseUpdate 设置为pendingUpdate的最后一个update
</span><span class="token doc-comment" style="color:#d4d0ab">     */</span><span>
</span><span>    lastBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> lastPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>    </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">     * current 也做上面同样的处理
</span><span class="token doc-comment" style="color:#d4d0ab">     */</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">const</span><span> current </span><span class="token" style="color:#00e0e0">=</span><span> workInProgress</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">alternate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>current </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// This is always non-null on a ClassComponent or HostRoot</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> </span><span class="token literal-property" style="color:#ffa07a">currentQueue</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">State</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span>current</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">updateQueue</span><span class="token" style="color:#00e0e0">:</span><span> any</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> currentLastBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> currentQueue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lastBaseUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>currentLastBaseUpdate </span><span class="token" style="color:#00e0e0">!==</span><span> lastBaseUpdate</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>currentLastBaseUpdate </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          currentQueue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">firstBaseUpdate</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> firstPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          currentLastBaseUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> firstPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        currentQueue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lastBaseUpdate</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> lastPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>每次处理update时都要从上一次第一个跳过的位置开始计算，比如计算<code>B2</code>时要用<code>A1</code>的结果<code>2</code>作为初始值，而不是<code>C1</code>的结果<code>3</code>；同时将新的update追加在后面，这样最终的执行顺序才是正确的。</p>
<h3>执行baseUpdate</h3>
<pre><div style="color:#f8f8f2;background:#2b2b2b;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-js" style="color:#f8f8f2;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>   </span><span class="token" style="color:#d4d0ab">// 如果存在上次跳过的Update，就执行该逻辑</span><span>
</span><span>  </span><span class="token" style="color:#d4d0ab">// 如果baseUpdate存在相同或者更高的优先级的任务，就执行优先级对应的任务</span><span>
</span><span>  </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>firstBaseUpdate </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">let</span><span> newState </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">baseState</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">let</span><span> newLanes </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token maybe-class-name">NoLanes</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">let</span><span> newBaseState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">let</span><span> newFirstBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#00e0e0">let</span><span> newLastBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">let</span><span> update </span><span class="token" style="color:#00e0e0">=</span><span> firstBaseUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d0ab">// 开始处理update</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">do</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> updateLane </span><span class="token" style="color:#00e0e0">=</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lane</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">const</span><span> updateEventTime </span><span class="token" style="color:#00e0e0">=</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">eventTime</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token" style="color:#d4d0ab">// </span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">!</span><span class="token" style="color:#ffd700">isSubsetOfLanes</span><span class="token" style="color:#fefefe">(</span><span>renderLanes</span><span class="token" style="color:#fefefe">,</span><span> updateLane</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">         * 将优先级不够的任务添加到新的firstBaseUpdate上，执行结束后添加到fiber的updateQueue的firstBaseUpdate上
</span><span class="token doc-comment" style="color:#d4d0ab">         */</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> </span><span class="token literal-property" style="color:#ffa07a">clone</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Update</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">State</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token literal-property" style="color:#ffa07a">eventTime</span><span class="token" style="color:#00e0e0">:</span><span> updateEventTime</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          </span><span class="token literal-property" style="color:#ffa07a">lane</span><span class="token" style="color:#00e0e0">:</span><span> updateLane</span><span class="token" style="color:#fefefe">,</span><span>
</span>
<span>          </span><span class="token literal-property" style="color:#ffa07a">tag</span><span class="token" style="color:#00e0e0">:</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">tag</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          </span><span class="token literal-property" style="color:#ffa07a">payload</span><span class="token" style="color:#00e0e0">:</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">payload</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          </span><span class="token literal-property" style="color:#ffa07a">callback</span><span class="token" style="color:#00e0e0">:</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">callback</span><span class="token" style="color:#fefefe">,</span><span>
</span>
<span>          </span><span class="token literal-property" style="color:#ffa07a">next</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>newLastBaseUpdate </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">           * 第一个跳过的update作为新的firstBaseUpdate，后面会放在udpateQueue上
</span><span class="token doc-comment" style="color:#d4d0ab">           */</span><span>
</span><span>          newFirstBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> newLastBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> clone</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">           * 第一个跳过的任务的前一个任务的执行后的state
</span><span class="token doc-comment" style="color:#d4d0ab">           */</span><span>
</span><span>          newBaseState </span><span class="token" style="color:#00e0e0">=</span><span> newState</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          newLastBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> newLastBaseUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> clone</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        newLanes </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">mergeLanes</span><span class="token" style="color:#fefefe">(</span><span>newLanes</span><span class="token" style="color:#fefefe">,</span><span> updateLane</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">         * 如果优先级足够，就执行update
</span><span class="token doc-comment" style="color:#d4d0ab">         */</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>newLastBaseUpdate </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">           * 如果newLastBaseUpdate存在，说明前面又跳过的Update，后续的所有Update又要重新形成baseUpdate
</span><span class="token doc-comment" style="color:#d4d0ab">           */</span><span>
</span><span>          </span><span class="token" style="color:#00e0e0">const</span><span> </span><span class="token literal-property" style="color:#ffa07a">clone</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Update</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">State</span><span class="token" style="color:#00e0e0">&gt;</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>            </span><span class="token literal-property" style="color:#ffa07a">eventTime</span><span class="token" style="color:#00e0e0">:</span><span> updateEventTime</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            </span><span class="token literal-property" style="color:#ffa07a">lane</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">NoLane</span><span class="token" style="color:#fefefe">,</span><span>
</span>
<span>            </span><span class="token literal-property" style="color:#ffa07a">tag</span><span class="token" style="color:#00e0e0">:</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">tag</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            </span><span class="token literal-property" style="color:#ffa07a">payload</span><span class="token" style="color:#00e0e0">:</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">payload</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>            </span><span class="token literal-property" style="color:#ffa07a">callback</span><span class="token" style="color:#00e0e0">:</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">callback</span><span class="token" style="color:#fefefe">,</span><span>
</span>
<span>            </span><span class="token literal-property" style="color:#ffa07a">next</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          </span><span class="token" style="color:#fefefe">}</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          newLastBaseUpdate </span><span class="token" style="color:#00e0e0">=</span><span> newLastBaseUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> clone</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>        </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">         * 处理update后得到新的state
</span><span class="token doc-comment" style="color:#d4d0ab">         */</span><span>
</span><span>        newState </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">getStateFromUpdate</span><span class="token" style="color:#fefefe">(</span><span>
</span><span>          workInProgress</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          queue</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          update</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          newState</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          props</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>          instance</span><span class="token" style="color:#fefefe">,</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#00e0e0">const</span><span> callback </span><span class="token" style="color:#00e0e0">=</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">callback</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>
</span><span>          callback </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span> </span><span class="token" style="color:#00e0e0">&amp;&amp;</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// If the update was already committed, we should not queue its</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// callback again.</span><span>
</span><span>          update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lane</span><span> </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token maybe-class-name">NoLane</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          workInProgress</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">flags</span><span> </span><span class="token" style="color:#00e0e0">|=</span><span> </span><span class="token maybe-class-name">Callback</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 标记这个fiber需要执行state更新后的回调</span><span>
</span><span>          </span><span class="token" style="color:#00e0e0">const</span><span> effects </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">effects</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 收集副作用，放到update上</span><span>
</span><span>          </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>effects </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>            queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">effects</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">[</span><span>update</span><span class="token" style="color:#fefefe">]</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>            effects</span><span class="token" style="color:#fefefe">.</span><span class="token method property-access" style="color:#ffd700">push</span><span class="token" style="color:#fefefe">(</span><span>update</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      update </span><span class="token" style="color:#00e0e0">=</span><span> update</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span class="token" style="color:#fefefe">;</span><span> 
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>update </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span> 
</span><span>        </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">         * 如果baseUpdate执行完了，判断是否又产生了新的update
</span><span class="token doc-comment" style="color:#d4d0ab">         */</span><span>
</span><span>        pendingQueue </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">shared</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">pending</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>pendingQueue </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token control-flow" style="color:#00e0e0">break</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// An update was scheduled from inside a reducer. Add the new</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// pending updates to the end of the list and keep processing.</span><span>
</span><span>          </span><span class="token" style="color:#00e0e0">const</span><span> lastPendingUpdate </span><span class="token" style="color:#00e0e0">=</span><span> pendingQueue</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// Intentionally unsound. Pending updates form a circular list, but we</span><span>
</span><span>          </span><span class="token" style="color:#d4d0ab">// unravel them when transferring them to the base queue.</span><span>
</span><span>          </span><span class="token" style="color:#00e0e0">const</span><span> firstPendingUpdate </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>lastPendingUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span class="token" style="color:#00e0e0">:</span><span> any</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Update</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">State</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          lastPendingUpdate</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          update </span><span class="token" style="color:#00e0e0">=</span><span> firstPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lastBaseUpdate</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> lastPendingUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>          queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">shared</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">pending</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">while</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#00e0e0">true</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>newLastBaseUpdate </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      newBaseState </span><span class="token" style="color:#00e0e0">=</span><span> newState</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span>    
<span>    </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">     * 执行完毕后将 baseState、firstBaseUpdate和lastBaseUpdate设置到updateQueue上
</span><span class="token doc-comment" style="color:#d4d0ab">     */</span><span>
</span><span>    queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">baseState</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>newBaseState</span><span class="token" style="color:#00e0e0">:</span><span> any</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">State</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span> 
</span><span>    queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">firstBaseUpdate</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> newFirstBaseUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lastBaseUpdate</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> newLastBaseUpdate</span><span class="token" style="color:#fefefe">;</span><span>
</span>
<span>    </span><span class="token" style="color:#00e0e0">const</span><span> lastInterleaved </span><span class="token" style="color:#00e0e0">=</span><span> queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">shared</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">interleaved</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>lastInterleaved </span><span class="token" style="color:#00e0e0">!==</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>      </span><span class="token" style="color:#00e0e0">let</span><span> interleaved </span><span class="token" style="color:#00e0e0">=</span><span> lastInterleaved</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#00e0e0">do</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span><span>        newLanes </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#ffd700">mergeLanes</span><span class="token" style="color:#fefefe">(</span><span>newLanes</span><span class="token" style="color:#fefefe">,</span><span> interleaved</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lane</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>        interleaved </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token" style="color:#fefefe">(</span><span class="token" style="color:#fefefe">(</span><span>interleaved</span><span class="token" style="color:#00e0e0">:</span><span> any</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">next</span><span class="token" style="color:#00e0e0">:</span><span> </span><span class="token maybe-class-name">Update</span><span class="token" style="color:#00e0e0">&lt;</span><span class="token maybe-class-name">State</span><span class="token" style="color:#00e0e0">&gt;</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>      </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">while</span><span> </span><span class="token" style="color:#fefefe">(</span><span>interleaved </span><span class="token" style="color:#00e0e0">!==</span><span> lastInterleaved</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span> </span><span class="token control-flow" style="color:#00e0e0">else</span><span> </span><span class="token control-flow" style="color:#00e0e0">if</span><span> </span><span class="token" style="color:#fefefe">(</span><span>firstBaseUpdate </span><span class="token" style="color:#00e0e0">===</span><span> </span><span class="token null nil" style="color:#00e0e0">null</span><span class="token" style="color:#fefefe">)</span><span> </span><span class="token" style="color:#fefefe">{</span><span>
</span>
<span>      queue</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">shared</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lanes</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> </span><span class="token maybe-class-name">NoLanes</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    </span><span class="token" style="color:#fefefe">}</span><span>
</span>
<span>    </span><span class="token" style="color:#ffd700">markSkippedUpdateLanes</span><span class="token" style="color:#fefefe">(</span><span>newLanes</span><span class="token" style="color:#fefefe">)</span><span class="token" style="color:#fefefe">;</span><span>
</span><span>    workInProgress</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">lanes</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> newLanes</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 将优先级不够的lanes放到节点的lanes上</span><span>
</span><span>    </span><span class="token doc-comment" style="color:#d4d0ab">/**
</span><span class="token doc-comment" style="color:#d4d0ab">     * 更新state
</span><span class="token doc-comment" style="color:#d4d0ab">    */</span><span>
</span><span>    workInProgress</span><span class="token" style="color:#fefefe">.</span><span class="token property-access">memoizedState</span><span> </span><span class="token" style="color:#00e0e0">=</span><span> newState</span><span class="token" style="color:#fefefe">;</span><span> </span><span class="token" style="color:#d4d0ab">// 设置新的state</span><span>
</span><span>  </span><span class="token" style="color:#fefefe">}</span></code></div></pre>
<p>每次处理update时都会先判断优先级：</p>
<ol>
<li>如果优先级不够，就跳过。同时设置新的baseState，firstBaseUpdate，lastBaseUpdate.</li>
<li>如果优先级够：</li>
<li>如果存在跳过的update，则该节点也要在baseUpdate上</li>
<li>执行udpate，得到新的state</li>
<li>将新的baseState、firstBaseUpdate、lastBaseUpdate添加到updateQueue上。</li>
</ol>
<h2>总结</h2>
<p>react使用baseUpdate和baseState来保证class组件中更新的正确性，因为react每次更新都会产生一个update，每个update的优先级不同；同时每个更新任务只会处理最高优先级的update，所以优先级低的就会跳过，下一次再处理。</p></div></div></div></div><div class="style_post_notice__eruHe"><div>本文链接: <a href="https://vwood.xyz/blog/fbd908c6-d6e4-4158-9581-fe08ac759e84">https://vwood.xyz/blog/fbd908c6-d6e4-4158-9581-fe08ac759e84</a> </div><div>关于博主: 评论和私信会在第一时间回复</div><div>版权声明: 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</div></div></div></div></div><div class="style_ads__0jIPf"><ins class="adsbygoogle" style="display:block;text-align:center;height:100px" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-6887995008287565" data-ad-slot="2469914690"></ins></div><section class="style_comments__vfE9U"></section></div><div class="style_sidebar__85_45"><div class="style_operator__vQh_M"><div class="style_operator-header__pJr2j"><div><span class="ant-avatar ant-avatar-sm ant-avatar-circle ant-avatar-image"><img src="//file.vwood.xyz/2023/06/11/upload_ssaf3w2dlo0xox7alrcrca1704a6j2fn.jpg!/fw/60"/></span></div><div class="style_operator-header-name-wrapper__OcmjB"><div class="style_operator-name__uEOGB">文钦</div><div class="style_operator-description__sgYiS" title=""></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><div><div class="style_item__cXlIc">Github:  <a target="_blank" href="https://github.com/abelce">https://github.com/abelce</a></div><div class="style_item__cXlIc">邮箱:  <a href="mailto:abelce@163.com">abelce@163.com</a></div></div></div><div class="style_latest-article__hK7d9"><h3 class="style_latest-article-header__c8DEW">最新文章</h3><div class="style_latest-article-list__msMMg"><a class="style_article__9q3XZ" title="docker使用postgres" href="/blog/0517a4cb-be8a-47a5-b7c2-da7904a4ba67">docker使用postgres</a><a class="style_article__9q3XZ" title="babel配置文件加载" href="/blog/cd89eea1-6839-499b-8573-5a487afc48ef">babel配置文件加载</a><a class="style_article__9q3XZ" title="typescript使用" href="/blog/ef3bf6e0-6e9f-4704-8b9d-cdd4d1fa7a91">typescript使用</a><a class="style_article__9q3XZ" title="git设置超时设置" href="/blog/7b2f60f3-7b3e-4889-8062-30323d2af5cf">git设置超时设置</a><a class="style_article__9q3XZ" title="babel配置文件加载过程" href="/blog/fac66413-5460-4a89-93dd-2a287ee1d14e">babel配置文件加载过程</a></div></div></div></div></div></main><footer class="ant-layout-footer"><div class="style_footer__9WRvE"><div>本站由<!-- --> <a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="_blank"><img class="style_upyun__RuV1B" src="/images/又拍云_logo2.png"/></a> <!-- -->提供CDN加速/云存储服务</div></div></footer><div class="ant-back-top"></div></section><div></div><div class="ant-back-top"></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"category":{"id":"01c2bf92-d615-4600-9f0a-64db28de7345","name":"React"},"content":"本文介绍React更新的baseState，阐述baseState在updateQueue中的作用，以及工作原理。\n\n首先React中任务有着不同的优先级，优先级高的任务先执行，低的后执行。所以会出现先创建的任务后执行的情况。比如下面的例子：\n```\nA1 -\u003e B2 -\u003e C1 -\u003e D2\n```\n其中数字越小优先级越高，所以`A1`和`C1` 会优先执行，执行完后的更新队列就如下：\n```\nB2 -\u003e D2\n```\n\n假如每个任务对state的操作为如下：\n```\nconst [count, setCount] = useState(1)\nA1: setCount(count =\u003e count + 1)\nB2: setCount(count =\u003e count * 2)\nC1: setCount(count =\u003e count + 1)\nD2: setCount(count =\u003e count + 2)\n```\n首先如果不按照优先级，直接按照更新列表中任务的顺序执行，执行的过程就是\n```\nA: count = 1 + 1; //2\nB: count = 2 * 2; // 4\nC: count = 4 + 1; // 5\nD: count = 5 + 2; // 7\n```\n上面的执行结果为`count=7`\n\n如果按照优先级高的先执行，优先级低的后执行那么执行的顺序如下:\n```\n// 高优先级\nA1: count = 1 + 1; // 2\nC1: count = 2 + 1; // 3\n// 低优先级\nB2: count = 3 * 2; // 6\nD2: count = 6 + 2; // 8\n```\n执行结果为`count=8`，两种方式的执行结果竟然不一致。\n\n那么React时是怎么解决这个问题的呢?\n\n往下看。\n\n## baseState和baseUpdate\nreact在 updateQueue上用`baseState`、`firstBaseUpdate`、`lastBaseUpdate`来解决。\n\n这三个属性的作用：\n1. baseState：第一个被跳过的Update前一个Update的执行结果。\n2. firstBaseUpdate：第一个被跳过的Update\n3. lastBaseUpdate：最后一个Update，只要有Update被跳过，那么该元素就指向updateQueue的最后一个节点。\n   \n下面看一下processUpdateQueue源码的执行逻辑。\n\n### 将新的update追加到现有的baseUpdate后面\n\n```js\n  const queue: UpdateQueue\u003cState\u003e = (workInProgress.updateQueue: any);\n\n  hasForceUpdate = false;\n\n  if (__DEV__) {\n    currentlyProcessingQueue = queue.shared;\n  }\n\n  let firstBaseUpdate = queue.firstBaseUpdate; // 上次执行后的第一个baseUpdate\n  let lastBaseUpdate = queue.lastBaseUpdate; // 上次执行后的最后一个\n\n  // Check if there are pending updates. If so, transfer them to the base queue.\n  let pendingQueue = queue.shared.pending; // 本次待处理的update\n  if (pendingQueue !== null) {\n    \n    queue.shared.pending = null;\n\n    // The pending queue is circular. Disconnect the pointer between first\n    // and last so that it's non-circular.\n    const lastPendingUpdate = pendingQueue;\n    const firstPendingUpdate = lastPendingUpdate.next;\n    lastPendingUpdate.next = null;\n    /**\n     * 将pending update 追加到 base update上 \n     * */ \n    if (lastBaseUpdate === null) {\n      /**\n       * 如果baseUpdate没有数据，就是说上一次没有出现跳过某个update的情况，那么就将 firstBaseUpdate就为pendingUpdate的第一个节点 \n       */\n      firstBaseUpdate = firstPendingUpdate;\n    } else {\n      lastBaseUpdate.next = firstPendingUpdate;\n    }\n    /**\n     * lastBaseUpdate 设置为pendingUpdate的最后一个update\n     */\n    lastBaseUpdate = lastPendingUpdate;\n\n    /**\n     * current 也做上面同样的处理\n     */\n    const current = workInProgress.alternate;\n    if (current !== null) {\n      // This is always non-null on a ClassComponent or HostRoot\n      const currentQueue: UpdateQueue\u003cState\u003e = (current.updateQueue: any);\n      const currentLastBaseUpdate = currentQueue.lastBaseUpdate;\n      if (currentLastBaseUpdate !== lastBaseUpdate) {\n        if (currentLastBaseUpdate === null) {\n          currentQueue.firstBaseUpdate = firstPendingUpdate;\n        } else {\n          currentLastBaseUpdate.next = firstPendingUpdate;\n        }\n        currentQueue.lastBaseUpdate = lastPendingUpdate;\n      }\n    }\n  }\n```\n每次处理update时都要从上一次第一个跳过的位置开始计算，比如计算`B2`时要用`A1`的结果`2`作为初始值，而不是`C1`的结果`3`；同时将新的update追加在后面，这样最终的执行顺序才是正确的。\n\n\n### 执行baseUpdate\n```js\n   // 如果存在上次跳过的Update，就执行该逻辑\n  // 如果baseUpdate存在相同或者更高的优先级的任务，就执行优先级对应的任务\n  if (firstBaseUpdate !== null) {\n    let newState = queue.baseState;\n    let newLanes = NoLanes;\n\n    let newBaseState = null;\n    let newFirstBaseUpdate = null;\n    let newLastBaseUpdate = null;\n\n    let update = firstBaseUpdate;\n    // 开始处理update\n    do {\n      const updateLane = update.lane;\n      const updateEventTime = update.eventTime;\n      // \n      if (!isSubsetOfLanes(renderLanes, updateLane)) {\n        /**\n         * 将优先级不够的任务添加到新的firstBaseUpdate上，执行结束后添加到fiber的updateQueue的firstBaseUpdate上\n         */\n        const clone: Update\u003cState\u003e = {\n          eventTime: updateEventTime,\n          lane: updateLane,\n\n          tag: update.tag,\n          payload: update.payload,\n          callback: update.callback,\n\n          next: null,\n        };\n        if (newLastBaseUpdate === null) {\n          /**\n           * 第一个跳过的update作为新的firstBaseUpdate，后面会放在udpateQueue上\n           */\n          newFirstBaseUpdate = newLastBaseUpdate = clone;\n          /**\n           * 第一个跳过的任务的前一个任务的执行后的state\n           */\n          newBaseState = newState;\n        } else {\n          newLastBaseUpdate = newLastBaseUpdate.next = clone;\n        }\n        newLanes = mergeLanes(newLanes, updateLane);\n      } else {\n        /**\n         * 如果优先级足够，就执行update\n         */\n        if (newLastBaseUpdate !== null) {\n          /**\n           * 如果newLastBaseUpdate存在，说明前面又跳过的Update，后续的所有Update又要重新形成baseUpdate\n           */\n          const clone: Update\u003cState\u003e = {\n            eventTime: updateEventTime,\n            lane: NoLane,\n\n            tag: update.tag,\n            payload: update.payload,\n            callback: update.callback,\n\n            next: null,\n          };\n          newLastBaseUpdate = newLastBaseUpdate.next = clone;\n        }\n\n        /**\n         * 处理update后得到新的state\n         */\n        newState = getStateFromUpdate(\n          workInProgress,\n          queue,\n          update,\n          newState,\n          props,\n          instance,\n        );\n        const callback = update.callback;\n        if (\n          callback !== null \u0026\u0026\n          // If the update was already committed, we should not queue its\n          // callback again.\n          update.lane !== NoLane\n        ) {\n          workInProgress.flags |= Callback; // 标记这个fiber需要执行state更新后的回调\n          const effects = queue.effects; // 收集副作用，放到update上\n          if (effects === null) {\n            queue.effects = [update];\n          } else {\n            effects.push(update);\n          }\n        }\n      }\n      update = update.next; \n      if (update === null) { \n        /**\n         * 如果baseUpdate执行完了，判断是否又产生了新的update\n         */\n        pendingQueue = queue.shared.pending;\n        if (pendingQueue === null) {\n          break;\n        } else {\n          // An update was scheduled from inside a reducer. Add the new\n          // pending updates to the end of the list and keep processing.\n          const lastPendingUpdate = pendingQueue;\n          // Intentionally unsound. Pending updates form a circular list, but we\n          // unravel them when transferring them to the base queue.\n          const firstPendingUpdate = ((lastPendingUpdate.next: any): Update\u003cState\u003e);\n          lastPendingUpdate.next = null;\n          update = firstPendingUpdate;\n          queue.lastBaseUpdate = lastPendingUpdate;\n          queue.shared.pending = null;\n        }\n      }\n    } while (true);\n\n    if (newLastBaseUpdate === null) {\n      newBaseState = newState;\n    }\n    \n    /**\n     * 执行完毕后将 baseState、firstBaseUpdate和lastBaseUpdate设置到updateQueue上\n     */\n    queue.baseState = ((newBaseState: any): State); \n    queue.firstBaseUpdate = newFirstBaseUpdate;\n    queue.lastBaseUpdate = newLastBaseUpdate;\n\n    const lastInterleaved = queue.shared.interleaved;\n    if (lastInterleaved !== null) {\n      let interleaved = lastInterleaved;\n      do {\n        newLanes = mergeLanes(newLanes, interleaved.lane);\n        interleaved = ((interleaved: any).next: Update\u003cState\u003e);\n      } while (interleaved !== lastInterleaved);\n    } else if (firstBaseUpdate === null) {\n\n      queue.shared.lanes = NoLanes;\n    }\n\n    markSkippedUpdateLanes(newLanes);\n    workInProgress.lanes = newLanes; // 将优先级不够的lanes放到节点的lanes上\n    /**\n     * 更新state\n    */\n    workInProgress.memoizedState = newState; // 设置新的state\n  }\n```\n每次处理update时都会先判断优先级：\n1. 如果优先级不够，就跳过。同时设置新的baseState，firstBaseUpdate，lastBaseUpdate.\n2. 如果优先级够：\n  1. 如果存在跳过的update，则该节点也要在baseUpdate上\n  2. 执行udpate，得到新的state\n  3. 将新的baseState、firstBaseUpdate、lastBaseUpdate添加到updateQueue上。\n\n\n## 总结\nreact使用baseUpdate和baseState来保证class组件中更新的正确性，因为react每次更新都会产生一个update，每个update的优先级不同；同时每个更新任务只会处理最高优先级的update，所以优先级低的就会跳过，下一次再处理。\n\n\n","createTime":1697639370378,"creativeType":"original","description":"本文介绍React更新的baseState，阐述baseState在updateQueue中的作用，以及工作原理。\n\n首先React中任务有着不同的优先级，优先级高的任务先执行，低的后执行。所以会出现先创建的任务后执行的情况。比如下面的例子：\n\nA1 -B2 -\u003e C1 -\u003e D2\n\n其中数字越小优先级越高，所以A1和C1 会优先执行，执行完后的更新队列就如下：\n\nB","headerImg":"","id":"fbd908c6-d6e4-4158-9581-fe08ac759e84","isDeleted":false,"likeCount":0,"name":"baseState与baseUpdate.md","operator":{"avatar":"//file.vwood.xyz/2023/06/11/upload_ssaf3w2dlo0xox7alrcrca1704a6j2fn.jpg","description":"","email":"abelce@163.com","github":"https://github.com/abelce","id":"96f16846-31f2-489c-9af0-d4ca13e836e4","name":"文钦"},"operatorId":"96f16846-31f2-489c-9af0-d4ca13e836e4","tags":["react","baseState","updateQueue"],"updateTime":1697728338268,"viewCount":0},"id":"fbd908c6-d6e4-4158-9581-fe08ac759e84","latestArticleList":[{"id":"0517a4cb-be8a-47a5-b7c2-da7904a4ba67","name":"docker使用postgres","tags":[],"description":"","content":""},{"id":"cd89eea1-6839-499b-8573-5a487afc48ef","name":"babel配置文件加载","tags":[],"description":"","content":""},{"id":"ef3bf6e0-6e9f-4704-8b9d-cdd4d1fa7a91","name":"typescript使用","tags":[],"description":"","content":""},{"id":"7b2f60f3-7b3e-4889-8062-30323d2af5cf","name":"git设置超时设置","tags":[],"description":"","content":""},{"id":"fac66413-5460-4a89-93dd-2a287ee1d14e","name":"babel配置文件加载过程","tags":[],"description":"","content":""}]},"initialMobxState":{"userStore":{"currentUser":null,"users":[],"token":"","qiniuToken":"","userCount":0,"productCount":0,"commentCount":0,"settingType":"products"},"productStore":{"products":[],"total":0,"type":"","url":"","current":1,"product":null,"likesMap":{},"tabpane":"all","token":"","loading":false,"todayHunters":[],"today":[],"yesterday":[],"relatedProducts":[],"search":""},"commentStore":{"comments":[],"total":0,"current":0},"noteStore":{"token":"","notes":[],"total":0,"note":null},"askStore":{"token":"","asks":[],"total":0,"ask":null},"stypeStore":{"data":[]}},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"fbd908c6-d6e4-4158-9581-fe08ac759e84"},"buildId":"DO1R4oWI773V9D4_4YIM0","isFallback":false,"gsp":true,"appGip":true,"scriptLoader":[]}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-MMNJYR8ESW" crossorigin="anonymous" strategy="lazyOnload"></script><script>window.dataLayer = window.dataLayer || [];
              function gtag(){window.dataLayer.push(arguments)}
              gtag('js', new Date());
              gtag('config', 'G-MMNJYR8ESW');</script><script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.async=true
              hm.src = "https://hm.baidu.com/hm.js?ea0272238080a1dedd4e077d19445ced";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
            })();
            </script></body></html>